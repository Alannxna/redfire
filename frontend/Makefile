# RedFireå‰ç«¯é¡¹ç›®Makefile
# ==========================

.PHONY: help setup dev build test clean docker lint format

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help

# é¢œè‰²å®šä¹‰
RED=\033[0;31m
GREEN=\033[0;32m
YELLOW=\033[1;33m
BLUE=\033[0;34m
NC=\033[0m # No Color

help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "$(BLUE)RedFireå‰ç«¯é¡¹ç›® - å¯ç”¨å‘½ä»¤:$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "$(GREEN)%-20s$(NC) %s\n", $$1, $$2}'

# ğŸš€ å¼€å‘ç¯å¢ƒ
setup: ## åˆå§‹åŒ–é¡¹ç›®ï¼ˆå®‰è£…ä¾èµ–ã€æ„å»ºåŒ…ï¼‰
	@echo "$(YELLOW)ğŸš€ åˆå§‹åŒ–RedFireå‰ç«¯é¡¹ç›®...$(NC)"
	npm install
	npm run setup
	@echo "$(GREEN)âœ… é¡¹ç›®åˆå§‹åŒ–å®Œæˆï¼$(NC)"

dev: ## å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼ˆæ‰€æœ‰åº”ç”¨ï¼‰
	@echo "$(YELLOW)ğŸ”§ å¯åŠ¨å¼€å‘ç¯å¢ƒ...$(NC)"
	npm run dev

dev-web: ## å¯åŠ¨Webåº”ç”¨å¼€å‘æœåŠ¡å™¨
	@echo "$(YELLOW)ğŸŒ å¯åŠ¨Webåº”ç”¨...$(NC)"
	npm run dev:web

dev-packages: ## å¯åŠ¨åŒ…å¼€å‘æ¨¡å¼
	@echo "$(YELLOW)ğŸ“¦ å¯åŠ¨åŒ…å¼€å‘æ¨¡å¼...$(NC)"
	npm run dev:packages

# ğŸ—ï¸ æ„å»º
build: ## æ„å»ºæ‰€æœ‰åº”ç”¨å’ŒåŒ…
	@echo "$(YELLOW)ğŸ—ï¸ æ„å»ºæ‰€æœ‰é¡¹ç›®...$(NC)"
	npm run build
	@echo "$(GREEN)âœ… æ„å»ºå®Œæˆï¼$(NC)"

build-web: ## æ„å»ºWebåº”ç”¨
	@echo "$(YELLOW)ğŸŒ æ„å»ºWebåº”ç”¨...$(NC)"
	npm run build:web

build-packages: ## æ„å»ºæ‰€æœ‰åŒ…
	@echo "$(YELLOW)ğŸ“¦ æ„å»ºæ‰€æœ‰åŒ…...$(NC)"
	npm run build:packages

build-affected: ## æ„å»ºå—å½±å“çš„é¡¹ç›®ï¼ˆåŸºäºGitå·®å¼‚ï¼‰
	@echo "$(YELLOW)ğŸ¯ æ„å»ºå—å½±å“çš„é¡¹ç›®...$(NC)"
	npm run build:affected

# ğŸ§ª æµ‹è¯•
test: ## è¿è¡Œæ‰€æœ‰æµ‹è¯•
	@echo "$(YELLOW)ğŸ§ª è¿è¡Œæµ‹è¯•...$(NC)"
	npm run test

test-watch: ## è¿è¡Œæµ‹è¯•ï¼ˆç›‘å¬æ¨¡å¼ï¼‰
	@echo "$(YELLOW)ğŸ‘€ è¿è¡Œæµ‹è¯•ï¼ˆç›‘å¬æ¨¡å¼ï¼‰...$(NC)"
	npm run test:watch

test-coverage: ## è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
	@echo "$(YELLOW)ğŸ“Š ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š...$(NC)"
	npm run test:coverage

test-e2e: ## è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•
	@echo "$(YELLOW)ğŸ­ è¿è¡ŒE2Eæµ‹è¯•...$(NC)"
	npm run test:e2e

# ğŸ” ä»£ç è´¨é‡
lint: ## è¿è¡Œä»£ç æ£€æŸ¥
	@echo "$(YELLOW)ğŸ” è¿è¡Œä»£ç æ£€æŸ¥...$(NC)"
	npm run lint

lint-fix: ## è‡ªåŠ¨ä¿®å¤ä»£ç é—®é¢˜
	@echo "$(YELLOW)ğŸ”§ è‡ªåŠ¨ä¿®å¤ä»£ç é—®é¢˜...$(NC)"
	npm run lint:fix

format: ## æ ¼å¼åŒ–ä»£ç 
	@echo "$(YELLOW)ğŸ’… æ ¼å¼åŒ–ä»£ç ...$(NC)"
	npm run format

format-check: ## æ£€æŸ¥ä»£ç æ ¼å¼
	@echo "$(YELLOW)ğŸ“‹ æ£€æŸ¥ä»£ç æ ¼å¼...$(NC)"
	npm run format:check

type-check: ## TypeScriptç±»å‹æ£€æŸ¥
	@echo "$(YELLOW)ğŸ”¤ TypeScriptç±»å‹æ£€æŸ¥...$(NC)"
	npm run type-check

# ğŸ§¹ æ¸…ç†
clean: ## æ¸…ç†æ‰€æœ‰æ„å»ºäº§ç‰©å’Œä¾èµ–
	@echo "$(YELLOW)ğŸ§¹ æ¸…ç†é¡¹ç›®...$(NC)"
	npm run clean
	@echo "$(GREEN)âœ… æ¸…ç†å®Œæˆï¼$(NC)"

clean-dist: ## æ¸…ç†æ„å»ºäº§ç‰©
	@echo "$(YELLOW)ğŸ—‘ï¸ æ¸…ç†æ„å»ºäº§ç‰©...$(NC)"
	npm run clean:dist

clean-cache: ## æ¸…ç†Turboç¼“å­˜
	@echo "$(YELLOW)ğŸ’¨ æ¸…ç†Turboç¼“å­˜...$(NC)"
	npm run clean:cache

clean-deps: ## æ¸…ç†æ‰€æœ‰ä¾èµ–
	@echo "$(YELLOW)ğŸ“¦ æ¸…ç†ä¾èµ–...$(NC)"
	npm run clean:deps

# ğŸ³ Docker
docker-build: ## æ„å»ºDockeré•œåƒ
	@echo "$(YELLOW)ğŸ³ æ„å»ºDockeré•œåƒ...$(NC)"
	docker build -t redfire-frontend:latest .
	@echo "$(GREEN)âœ… Dockeré•œåƒæ„å»ºå®Œæˆï¼$(NC)"

docker-dev: ## å¯åŠ¨Dockerå¼€å‘ç¯å¢ƒ
	@echo "$(YELLOW)ğŸ³ å¯åŠ¨Dockerå¼€å‘ç¯å¢ƒ...$(NC)"
	docker-compose -f docker-compose.dev.yml up -d
	@echo "$(GREEN)âœ… Dockerå¼€å‘ç¯å¢ƒå·²å¯åŠ¨ï¼$(NC)"

docker-down: ## åœæ­¢Dockerå¼€å‘ç¯å¢ƒ
	@echo "$(YELLOW)ğŸ›‘ åœæ­¢Dockerå¼€å‘ç¯å¢ƒ...$(NC)"
	docker-compose -f docker-compose.dev.yml down
	@echo "$(GREEN)âœ… Dockerå¼€å‘ç¯å¢ƒå·²åœæ­¢ï¼$(NC)"

docker-logs: ## æŸ¥çœ‹Dockeræ—¥å¿—
	@echo "$(YELLOW)ğŸ“‹ æŸ¥çœ‹Dockeræ—¥å¿—...$(NC)"
	docker-compose -f docker-compose.dev.yml logs -f

# ğŸ“Š åˆ†æå’Œç›‘æ§
analyze: ## åˆ†ææ‰“åŒ…ä½“ç§¯
	@echo "$(YELLOW)ğŸ“Š åˆ†ææ‰“åŒ…ä½“ç§¯...$(NC)"
	npm run analyze

storybook: ## å¯åŠ¨Storybook
	@echo "$(YELLOW)ğŸ“š å¯åŠ¨Storybook...$(NC)"
	npm run storybook

build-storybook: ## æ„å»ºStorybook
	@echo "$(YELLOW)ğŸ“š æ„å»ºStorybook...$(NC)"
	npm run build-storybook

# ğŸ”„ ç‰ˆæœ¬ç®¡ç†
changeset: ## åˆ›å»ºchangeset
	@echo "$(YELLOW)ğŸ“ åˆ›å»ºchangeset...$(NC)"
	npm run changeset

version: ## æ›´æ–°ç‰ˆæœ¬å·
	@echo "$(YELLOW)ğŸ”¢ æ›´æ–°ç‰ˆæœ¬å·...$(NC)"
	npm run version-packages

release: ## å‘å¸ƒæ–°ç‰ˆæœ¬
	@echo "$(YELLOW)ğŸš€ å‘å¸ƒæ–°ç‰ˆæœ¬...$(NC)"
	npm run release

# ğŸ¯ å¿«é€Ÿå‘½ä»¤
quick-start: setup dev ## å¿«é€Ÿå¼€å§‹ï¼ˆè®¾ç½®+å¼€å‘ï¼‰

check: lint type-check test ## å…¨é¢æ£€æŸ¥ï¼ˆlint+ç±»å‹+æµ‹è¯•ï¼‰

ci: clean setup check build ## CIæµæ°´çº¿ï¼ˆæ¸…ç†+è®¾ç½®+æ£€æŸ¥+æ„å»ºï¼‰

# ğŸ“ˆ æ€§èƒ½æµ‹è¯•
perf: ## è¿è¡Œæ€§èƒ½æµ‹è¯•
	@echo "$(YELLOW)âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•...$(NC)"
	npm run build
	npm run preview &
	sleep 5
	npx lighthouse http://localhost:4173 --output html --output-path ./lighthouse-report.html
	@echo "$(GREEN)âœ… æ€§èƒ½æµ‹è¯•å®Œæˆï¼æŠ¥å‘Š: lighthouse-report.html$(NC)"

# ğŸ“± ç§»åŠ¨ç«¯é¢„è§ˆ
mobile-preview: ## ç§»åŠ¨ç«¯é¢„è§ˆæ¨¡å¼
	@echo "$(YELLOW)ğŸ“± å¯åŠ¨ç§»åŠ¨ç«¯é¢„è§ˆ...$(NC)"
	npm run build:web
	npm run preview &
	@echo "$(GREEN)ğŸŒ é¢„è§ˆåœ°å€: http://localhost:4173$(NC)"
	@echo "$(BLUE)ğŸ“± ä½¿ç”¨æ‰‹æœºè®¿é—®åŒç½‘æ®µIPè¿›è¡Œæµ‹è¯•$(NC)"

# çŠ¶æ€ä¿¡æ¯
status: ## æ˜¾ç¤ºé¡¹ç›®çŠ¶æ€
	@echo "$(BLUE)ğŸ“Š RedFireå‰ç«¯é¡¹ç›®çŠ¶æ€:$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸ“¦ ä¾èµ–çŠ¶æ€:$(NC)"
	@npm ls --depth=0 2>/dev/null || echo "$(RED)âŒ éœ€è¦è¿è¡Œ make setup$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸ—ï¸ æ„å»ºçŠ¶æ€:$(NC)"
	@if [ -d "dist" ] || [ -d "apps/web-app/dist" ]; then echo "$(GREEN)âœ… å­˜åœ¨æ„å»ºäº§ç‰©$(NC)"; else echo "$(RED)âŒ éœ€è¦è¿è¡Œ make build$(NC)"; fi
	@echo ""
	@echo "$(YELLOW)ğŸ§ª æµ‹è¯•è¦†ç›–ç‡:$(NC)"
	@if [ -d "coverage" ]; then echo "$(GREEN)âœ… å·²ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š$(NC)"; else echo "$(YELLOW)âš ï¸ è¿è¡Œ make test-coverage ç”Ÿæˆ$(NC)"; fi
