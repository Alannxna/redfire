# ğŸ“Š TODO-17: å›¾è¡¨å¼•æ“å¼€å‘

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

å¼€å‘åŸºäºvnpy-coreçš„ä¸“ä¸šé‡åŒ–å›¾è¡¨å¼•æ“ï¼Œå°†vnpyå¼ºå¤§çš„æ¡Œé¢å›¾è¡¨èƒ½åŠ›å®Œæ•´ç§»æ¤åˆ°ç°ä»£Webç¯å¢ƒã€‚

## ğŸ¯ ç›®æ ‡æˆæœ

### âœ… å·²å®Œæˆçš„æ ¸å¿ƒåŠŸèƒ½

#### 1. ğŸ—ï¸ æ ¸å¿ƒæ¶æ„è®¾è®¡ 
- **ChartEngineæ ¸å¿ƒå¼•æ“**: 500+è¡Œæ ¸å¿ƒä»£ç ï¼ŒåŸºäºvnpy-coreæ¶æ„
- **æ¨¡å—åŒ–è®¾è®¡**: æ•°æ®ç®¡ç†ã€æ¸²æŸ“å™¨ã€è®¡ç®—å™¨ã€APIç‹¬ç«‹è§£è€¦
- **å¼‚æ­¥æ¶æ„**: æ”¯æŒé«˜å¹¶å‘å›¾è¡¨ç®¡ç†å’Œå®æ—¶æ•°æ®å¤„ç†
- **ä¼ä¸šçº§è®¾è®¡**: å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†å’Œé”™è¯¯å¤„ç†

#### 2. ğŸ“Š æ•°æ®ç®¡ç†ç³»ç»Ÿ (ChartDataManager)
- **é«˜æ€§èƒ½ç¼“å­˜**: LRUç¼“å­˜ç­–ç•¥ï¼Œæ™ºèƒ½å†…å­˜ç®¡ç†
- **å¤šæ—¶é—´å‘¨æœŸ**: æ”¯æŒ1s-1wå…¨æ—¶é—´å‘¨æœŸKçº¿æ•°æ®
- **æ•°æ®æ£€ç´¢**: é«˜æ•ˆçš„æ—¶é—´èŒƒå›´æŸ¥è¯¢å’Œæ•°æ®ç»Ÿè®¡
- **è‡ªåŠ¨æ¸…ç†**: å®šæ—¶ç¼“å­˜æ¸…ç†å’Œæ€§èƒ½ä¼˜åŒ–

#### 3. ğŸ¨ Webæ¸²æŸ“å¼•æ“ (WebChartRenderer)
- **å¤šå›¾è¡¨ç±»å‹**: Kçº¿å›¾ã€åˆ†æ—¶çº¿ã€é¢ç§¯å›¾ã€ç –å‹å›¾
- **vnpyç®—æ³•ç§»æ¤**: å®Œæ•´ç§»æ¤vnpy-coreçš„æ¸²æŸ“é€»è¾‘
- **Canvasé€‚é…**: é’ˆå¯¹Web Canvas/WebGLä¼˜åŒ–
- **ä¸“ä¸šé…è‰²**: é‡‘èçº§é…è‰²æ–¹æ¡ˆå’Œä¸»é¢˜æ”¯æŒ

#### 4. ğŸ“ˆ æŠ€æœ¯æŒ‡æ ‡è®¡ç®—å™¨ (IndicatorCalculator)
- **20+ç§æŒ‡æ ‡**: MAã€EMAã€MACDã€RSIã€BOLLã€KDJã€ATRç­‰
- **vnpyç®—æ³•**: åŸºäºvnpy-coreæŒ‡æ ‡ç®—æ³•ç§»æ¤
- **numpyä¼˜åŒ–**: é«˜æ€§èƒ½æ•°ç»„è®¡ç®—å’Œå‘é‡åŒ–å¤„ç†
- **æ™ºèƒ½ç¼“å­˜**: å¢é‡è®¡ç®—å’Œç»“æœç¼“å­˜

#### 5. ğŸ”Œ å®Œæ•´APIæ¥å£
- **RESTful API**: å®Œæ•´çš„å›¾è¡¨CRUDæ“ä½œ
- **WebSocket**: å®æ—¶æ•°æ®æ¨é€å’Œè®¢é˜…ç®¡ç†
- **FastAPIé›†æˆ**: å®Œç¾é›†æˆåˆ°RedFireä¸»ç³»ç»Ÿ
- **Swaggeræ–‡æ¡£**: è‡ªåŠ¨ç”ŸæˆAPIæ–‡æ¡£

#### 6. ğŸ› ï¸ å·¥å…·å’Œç›‘æ§
- **LRUç¼“å­˜**: é«˜æ€§èƒ½ç¼“å­˜å®ç°ï¼Œæ”¯æŒTTL
- **æ€§èƒ½ç›‘æ§**: å®Œæ•´çš„æŒ‡æ ‡æ”¶é›†å’Œç»Ÿè®¡åˆ†æ
- **é”™è¯¯å¤„ç†**: å…¨é¢çš„å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•
- **èµ„æºç®¡ç†**: æ™ºèƒ½å†…å­˜ç®¡ç†å’Œèµ„æºæ¸…ç†

## ğŸ”§ æŠ€æœ¯å®ç°

### æ ¸å¿ƒç»„ä»¶æ¶æ„

```python
RedFire Chart Engine
â”œâ”€â”€ ChartEngine (æ ¸å¿ƒå¼•æ“)
â”‚   â”œâ”€â”€ å›¾è¡¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
â”‚   â”œâ”€â”€ è®¢é˜…è€…ç®¡ç†
â”‚   â””â”€â”€ å®æ—¶æ•°æ®æµå¤„ç†
â”œâ”€â”€ ChartDataManager (æ•°æ®ç®¡ç†)
â”‚   â”œâ”€â”€ ChartDataBuffer (é«˜æ€§èƒ½ç¼“å†²åŒº)
â”‚   â”œâ”€â”€ LRUç¼“å­˜ç­–ç•¥
â”‚   â””â”€â”€ æ•°æ®ç»Ÿè®¡åˆ†æ
â”œâ”€â”€ WebChartRenderer (Webæ¸²æŸ“)
â”‚   â”œâ”€â”€ å¤šå›¾è¡¨ç±»å‹æ”¯æŒ
â”‚   â”œâ”€â”€ Canvasæ¸²æŸ“é€‚é…
â”‚   â””â”€â”€ vnpyæ¸²æŸ“ç®—æ³•ç§»æ¤
â”œâ”€â”€ IndicatorCalculator (æŒ‡æ ‡è®¡ç®—)
â”‚   â”œâ”€â”€ TechnicalIndicators (æŠ€æœ¯æŒ‡æ ‡ç®—æ³•)
â”‚   â”œâ”€â”€ 20+ç§ä¸“ä¸šæŒ‡æ ‡
â”‚   â””â”€â”€ numpyæ€§èƒ½ä¼˜åŒ–
â””â”€â”€ APIæ¥å£å±‚
    â”œâ”€â”€ ChartEngineAPI (RESTful)
    â””â”€â”€ ChartWebSocketHandler (å®æ—¶æ¨é€)
```

### å…³é”®æŠ€æœ¯ç‰¹æ€§

#### 1. vnpyç®—æ³•ç§»æ¤
```python
# åŸºäºvnpy-coreçš„MACDç®—æ³•ç§»æ¤
@staticmethod
def macd(prices: np.ndarray, fast=12, slow=26, signal=9):
    ema_fast = TechnicalIndicators.ema(prices, fast)
    ema_slow = TechnicalIndicators.ema(prices, slow)
    macd_line = ema_fast - ema_slow
    signal_line = TechnicalIndicators.ema(macd_line, signal)
    histogram = macd_line - signal_line
    return macd_line, signal_line, histogram
```

#### 2. é«˜æ€§èƒ½æ•°æ®ç®¡ç†
```python
class ChartDataBuffer:
    def __init__(self, max_size: int = 10000):
        self.bars: deque[BarData] = deque(maxlen=max_size)
        self.datetime_index: Dict[datetime, int] = {}
    
    def add_bar(self, bar: BarData) -> None:
        # O(1)æ—¶é—´å¤æ‚åº¦çš„æ•°æ®æ·»åŠ 
        # è‡ªåŠ¨æ—¶é—´ç´¢å¼•ç®¡ç†
```

#### 3. Webæ¸²æŸ“é€‚é…
```python
def prepare_render_data(self, bars, indicators):
    # å°†vnpyæ•°æ®æ ¼å¼è½¬æ¢ä¸ºWeb Canvasæ ¼å¼
    candles = self._prepare_candle_data(bars)
    lines = self._prepare_indicator_data(indicators) 
    return ChartRenderData(candles=candles, lines=lines)
```

### APIæ¥å£è®¾è®¡

#### RESTful API
```http
POST /api/chart/charts          # åˆ›å»ºå›¾è¡¨
GET  /api/chart/charts          # è·å–å›¾è¡¨åˆ—è¡¨
GET  /api/chart/charts/{id}/data # è·å–å›¾è¡¨æ•°æ®
POST /api/chart/charts/{id}/indicators # æ·»åŠ æŒ‡æ ‡
```

#### WebSocketæ¥å£
```javascript
// è®¢é˜…å›¾è¡¨å®æ—¶æ•°æ®
{
    "action": "subscribe",
    "chart_id": "BTCUSDT_1m"
}

// æ¥æ”¶å®æ—¶æ›´æ–°
{
    "type": "chart_update",
    "chart_id": "BTCUSDT_1m", 
    "data": {...}
}
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### ç›®æ ‡æ€§èƒ½
- **æ¸²æŸ“æ€§èƒ½**: 60FPSä¸æ»‘æ¸²æŸ“
- **æ•°æ®å®¹é‡**: å•å›¾è¡¨æ”¯æŒ10ä¸‡+Kçº¿
- **å¹¶å‘èƒ½åŠ›**: 100+ç”¨æˆ·åŒæ—¶è§‚çœ‹
- **å“åº”æ—¶é—´**: APIå“åº” < 100ms
- **å†…å­˜ä½¿ç”¨**: å•å›¾è¡¨ < 50MB

### æ€§èƒ½ä¼˜åŒ–
- **LRUç¼“å­˜**: å‡å°‘é‡å¤è®¡ç®—
- **numpyå‘é‡åŒ–**: æŒ‡æ ‡è®¡ç®—ä¼˜åŒ–
- **å¼‚æ­¥å¤„ç†**: éé˜»å¡æ•°æ®å¤„ç†
- **æ™ºèƒ½æ¸…ç†**: è‡ªåŠ¨å†…å­˜ç®¡ç†

## ğŸ”— ç³»ç»Ÿé›†æˆ

### RedFireä¸»ç³»ç»Ÿé›†æˆ

```python
# backend/core/app.py
def _register_business_routes(self):
    # å›¾è¡¨å¼•æ“é›†æˆ
    from core.chart_engine.src.core.chart_engine import ChartEngine
    from core.chart_engine.src.api.chart_api import ChartEngineAPI
    
    chart_engine = ChartEngine()
    chart_api = ChartEngineAPI(chart_engine)
    
    self.app.include_router(chart_api.get_router())
    self._components['chart_engine'] = chart_engine
```

### å¯åŠ¨æµç¨‹é›†æˆ
```python
async def _startup(self):
    # å¯åŠ¨å›¾è¡¨å¼•æ“
    if 'chart_engine' in self._components:
        await self._components['chart_engine'].start()
    
    # å¯åŠ¨WebSocketå¤„ç†å™¨  
    if 'chart_ws_handler' in self._components:
        await self._components['chart_ws_handler'].start()
```

## ğŸ“š ä½¿ç”¨æ–‡æ¡£

### å¿«é€Ÿå¼€å§‹

```python
# 1. åˆ›å»ºå›¾è¡¨å¼•æ“
engine = ChartEngine()
await engine.start()

# 2. åˆ›å»ºå›¾è¡¨
chart = await engine.create_chart(
    chart_id="BTCUSDT_1m",
    symbol="BTCUSDT",
    chart_type=ChartType.CANDLESTICK,
    interval=Interval.MINUTE_1
)

# 3. è®¢é˜…å›¾è¡¨
subscription = await engine.subscribe_chart("BTCUSDT_1m", "user_123")

# 4. è·å–æ¸²æŸ“æ•°æ®
render_data = await engine.get_chart_render_data("BTCUSDT_1m")
```

### æŠ€æœ¯æŒ‡æ ‡é…ç½®
```python
# æ·»åŠ ç§»åŠ¨å¹³å‡çº¿
ma_config = IndicatorConfig(
    type=IndicatorType.MA,
    name="MA20",
    parameters={"period": 20},
    color="#FF6B6B"
)

# æ·»åŠ MACD
macd_config = IndicatorConfig(
    type=IndicatorType.MACD,
    name="MACD",
    parameters={"fast": 12, "slow": 26, "signal": 9}
)
```

## ğŸ¯ åº”ç”¨åœºæ™¯

### 1. å®æ—¶äº¤æ˜“å›¾è¡¨
- Kçº¿å›¾è¡¨å®æ—¶æ˜¾ç¤º
- æŠ€æœ¯æŒ‡æ ‡åŠ¨æ€è®¡ç®—
- å¤šæ—¶é—´å‘¨æœŸåˆ‡æ¢

### 2. ç­–ç•¥å›æµ‹å±•ç¤º
- å†å²æ•°æ®å›æ”¾
- äº¤æ˜“ä¿¡å·æ ‡è®°
- æ”¶ç›Šæ›²çº¿å±•ç¤º

### 3. æŠ•ç ”åˆ†æå·¥å…·
- å¤šå“ç§å¯¹æ¯”åˆ†æ
- è‡ªå®šä¹‰æŒ‡æ ‡å¼€å‘
- æ•°æ®å¯¼å‡ºåŠŸèƒ½

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½å®Œæ•´æ€§ âœ…
- [x] æ ¸å¿ƒå›¾è¡¨å¼•æ“å®ç°
- [x] å¤šç§å›¾è¡¨ç±»å‹æ”¯æŒ
- [x] æŠ€æœ¯æŒ‡æ ‡è®¡ç®—å®Œæ•´
- [x] APIæ¥å£åŠŸèƒ½é½å…¨
- [x] WebSocketå®æ—¶æ¨é€

### æ€§èƒ½è¦æ±‚ âœ…  
- [x] é«˜å¹¶å‘å›¾è¡¨ç®¡ç†
- [x] é«˜æ€§èƒ½æ•°æ®å¤„ç†
- [x] å†…å­˜ä½¿ç”¨ä¼˜åŒ–
- [x] å“åº”æ—¶é—´è¾¾æ ‡

### é›†æˆæµ‹è¯• âœ…
- [x] RedFireä¸»ç³»ç»Ÿé›†æˆ
- [x] APIæ¥å£å¯ç”¨æ€§
- [x] WebSocketè¿æ¥ç¨³å®š
- [x] é”™è¯¯å¤„ç†å®Œå–„

### æ–‡æ¡£è´¨é‡ âœ…
- [x] READMEæŠ€æœ¯æ–‡æ¡£
- [x] APIæ¥å£æ–‡æ¡£
- [x] ä½¿ç”¨ç¤ºä¾‹å®Œæ•´
- [x] å¼€å‘æŒ‡å—è¯¦ç»†

## ğŸ‰ é¡¹ç›®ä»·å€¼

### æŠ€æœ¯ä»·å€¼
- **vnpyèƒ½åŠ›WebåŒ–**: å°†å¼ºå¤§çš„æ¡Œé¢å›¾è¡¨èƒ½åŠ›å¸¦åˆ°Web
- **ä¼ä¸šçº§æ¶æ„**: é«˜å¯ç”¨ã€é«˜æ€§èƒ½çš„ä¸“ä¸šå›¾è¡¨å¼•æ“
- **å¼€æºç”Ÿæ€**: å¯æ‰©å±•çš„æŠ€æœ¯æŒ‡æ ‡å’Œå›¾è¡¨ç±»å‹

### ä¸šåŠ¡ä»·å€¼  
- **ç”¨æˆ·ä½“éªŒ**: ä¸“ä¸šçº§å›¾è¡¨å±•ç¤ºèƒ½åŠ›
- **åŠŸèƒ½å®Œæ•´**: æ»¡è¶³é‡åŒ–äº¤æ˜“å…¨åœºæ™¯éœ€æ±‚
- **æŠ€æœ¯é¢†å…ˆ**: è¡Œä¸šé¢†å…ˆçš„Webå›¾è¡¨æŠ€æœ¯

### ç”Ÿæ€ä»·å€¼
- **æŠ€æœ¯ç§¯ç´¯**: ä¸ºRedFireæä¾›æ ¸å¿ƒå›¾è¡¨èƒ½åŠ›
- **å¯æ‰©å±•æ€§**: æ”¯æŒæœªæ¥ä¸šåŠ¡æ‰©å±•éœ€æ±‚
- **æ ‡å‡†åŒ–**: å»ºç«‹å›¾è¡¨å¼•æ“æŠ€æœ¯æ ‡å‡†

---

**ğŸ¯ æ€»ç»“**: æˆåŠŸæ„å»ºäº†åŸºäºvnpy-coreçš„ä¸“ä¸šé‡åŒ–å›¾è¡¨å¼•æ“ï¼Œå®ç°äº†ä»æ¡Œé¢åˆ°Webçš„å®Œæ•´æŠ€æœ¯è¿ç§»ï¼Œä¸ºRedFireæä¾›äº†ä¼ä¸šçº§çš„å›¾è¡¨å±•ç¤ºèƒ½åŠ›ã€‚é¡¹ç›®æ¶µç›–æ ¸å¿ƒå¼•æ“ã€æ•°æ®ç®¡ç†ã€æ¸²æŸ“å™¨ã€æŒ‡æ ‡è®¡ç®—ç­‰å®Œæ•´æŠ€æœ¯æ ˆï¼Œå…·å¤‡é«˜æ€§èƒ½ã€é«˜å¯ç”¨ã€æ˜“æ‰©å±•çš„ç‰¹ç‚¹ã€‚