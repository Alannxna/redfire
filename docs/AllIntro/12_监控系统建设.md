# ğŸ“Š TODO-12: ç›‘æ§ç³»ç»Ÿå»ºè®¾

## ğŸ¯ ä»»åŠ¡æ¦‚è¿°

**ä»»åŠ¡ID**: monitor_01  
**ä¼˜å…ˆçº§**: ä¸­  
**é¢„ä¼°å·¥æœŸ**: 4-5å¤©  
**è´Ÿè´£æ¨¡å—**: ç›‘æ§è¿ç»´

### é—®é¢˜æè¿°
å»ºç«‹å®Œå–„çš„ç›‘æ§ç³»ç»Ÿï¼ŒåŒ…æ‹¬Prometheus+GrafanaæŒ‡æ ‡ç›‘æ§ã€ELKæ—¥å¿—æ”¶é›†åˆ†æï¼Œä»¥åŠè‡ªå®šä¹‰ä¸šåŠ¡ç›‘æ§æŒ‡æ ‡ï¼Œç¡®ä¿ç³»ç»Ÿå¥åº·çŠ¶æ€å¯è§‚æµ‹ã€‚

## ğŸ” ç°çŠ¶åˆ†æ

### å·²æœ‰ç›‘æ§åŸºç¡€ âœ…

#### 1. å®Œå–„çš„ç›‘æ§é…ç½®ä½“ç³»
```python
# config/backend/monitor_config.py - 647è¡Œè¯¦ç»†é…ç½®
âœ… ç³»ç»Ÿçº§æŒ‡æ ‡é…ç½® (CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œã€è´Ÿè½½ç­‰)
âœ… åº”ç”¨çº§æŒ‡æ ‡é…ç½® (è¯·æ±‚ç‡ã€å“åº”æ—¶é—´ã€é”™è¯¯ç‡ç­‰)
âœ… å‘Šè­¦è§„åˆ™é…ç½® (8ä¸ªæ ¸å¿ƒå‘Šè­¦è§„åˆ™)
âœ… é€šçŸ¥æ¸ é“é…ç½® (é‚®ä»¶ã€Webhookã€çŸ­ä¿¡ã€æ—¥å¿—)
âœ… æœåŠ¡ç›‘æ§é…ç½® (6ä¸ªæ ¸å¿ƒæœåŠ¡è¯¦ç»†é…ç½®)
âœ… æ•°æ®ä¿ç•™ç­–ç•¥ (å®æ—¶ã€çŸ­æœŸã€ä¸­æœŸã€é•¿æœŸ)

MONITORED_SERVICES_DETAILED = {
    "vnpy_core": {"name": "ğŸ”¥ VnPyæ ¸å¿ƒæœåŠ¡", "port": 8006, "priority": "critical"},
    "user_trading": {"name": "ğŸ‘¤ ç”¨æˆ·äº¤æ˜“æœåŠ¡", "port": 8001, "priority": "high"},
    "strategy_data": {"name": "ğŸ“Š ç­–ç•¥æ•°æ®æœåŠ¡", "port": 8002, "priority": "high"},
    "gateway": {"name": "ğŸŒ ç½‘å…³é€‚é…æœåŠ¡", "port": 8004, "priority": "medium"},
    "monitor": {"name": "ğŸ“± ç›‘æ§é€šçŸ¥æœåŠ¡", "port": 8005, "priority": "medium"},
    "frontend": {"name": "ğŸŒ å‰ç«¯å¼€å‘æœåŠ¡å™¨", "port": 3000, "priority": "medium"}
}
```

#### 2. ä¸“ä¸šç›‘æ§å®ç°
```python
# backend/core/tradingEngine/monitoring/domestic_gateway_monitor.py - 251è¡Œ
âœ… DomesticGatewayMonitor (å›½å†…åˆ¸å•†ç½‘å…³ä¸“ç”¨ç›‘æ§)
âœ… å®æ—¶æ€§èƒ½ç›‘æ§å’Œå»¶è¿Ÿç»Ÿè®¡
âœ… å‘Šè­¦è§„åˆ™ç®¡ç†å’Œè¯„ä¼°
âœ… è¿è§„è®¡æ•°å™¨å’Œæ´»è·ƒå‘Šè­¦ç®¡ç†
âœ… å‘Šè­¦å†å²è®°å½•å’Œç»Ÿè®¡åˆ†æ
âœ… å¼‚æ­¥ç›‘æ§å¾ªç¯å’Œå¥åº·æ£€æŸ¥

class DomesticGatewayMonitor:
    # å®Œæ•´çš„ç›‘æ§ç³»ç»Ÿå®ç°
    - å®æ—¶æ€§èƒ½ç›‘æ§: PerformanceMetricsæ•°æ®ç±»
    - å‘Šè­¦ç³»ç»Ÿ: AlertRuleå’ŒAlertç®¡ç†
    - ç›‘æ§å¾ªç¯: å¼‚æ­¥ç›‘æ§ä»»åŠ¡
    - æ•°æ®å­˜å‚¨: metrics_historyå’Œlatency_data
    - ç»Ÿè®¡åˆ†æ: æˆåŠŸç‡ã€å¹³å‡å»¶è¿Ÿã€é”™è¯¯ç»Ÿè®¡
```

#### 3. Dockerå®¹å™¨åŒ–ç›‘æ§
```yaml
# backend/gateway/docker-compose.yml
âœ… PrometheusæœåŠ¡ (ç«¯å£9090)
âœ… GrafanaæœåŠ¡ (ç«¯å£3000)
âœ… æ•°æ®æŒä¹…åŒ–å·é…ç½®
âœ… ç›‘æ§ç½‘ç»œé…ç½®

prometheus:
  image: prom/prometheus:latest
  volumes: ["./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml"]
  
grafana:
  image: grafana/grafana:latest
  volumes: ["./monitoring/grafana/dashboards:/var/lib/grafana/dashboards"]
```

#### 4. è¿ç»´æŒ‡å—æ–‡æ¡£
```markdown
# docs/operations/monitoringGuide.md - 82è¡Œå®Œæ•´æŒ‡å—
âœ… ç›‘æ§ä½“ç³»è¯´æ˜ (ç³»ç»Ÿã€åº”ç”¨ã€ä¸šåŠ¡ä¸‰å±‚ç›‘æ§)
âœ… Prometheus+Grafanaé…ç½®ç¤ºä¾‹
âœ… ELK Stacké…ç½®æ¨¡æ¿
âœ… è‡ªå®šä¹‰ç›‘æ§æŒ‡æ ‡ä»£ç ç¤ºä¾‹
```

### ä¸»è¦ç¼ºå£åˆ†æ ğŸ”

#### 1. å®ç°å®Œæ•´åº¦ (85%å®Œæˆ)
- âœ… ç›‘æ§é…ç½®: 100%å®Œå–„
- âœ… ä¸“ä¸šç›‘æ§: DomesticGatewayMonitorå·²å®ç°
- âŒ ç»Ÿä¸€ç›‘æ§æœåŠ¡: ç¼ºä¹å…¨ç³»ç»Ÿç»Ÿä¸€ç›‘æ§
- âŒ æŒ‡æ ‡æ”¶é›†å™¨: ç¼ºä¹Prometheusé›†æˆ
- âŒ Grafanaä»ªè¡¨æ¿: ç¼ºä¹å®é™…ä»ªè¡¨æ¿æ–‡ä»¶

#### 2. é›†æˆå®Œæ•´åº¦ (60%å®Œæˆ)
- âœ… VnPyå¼•æ“é›†æˆ: DomesticGatewayMonitorä¸“é—¨é€‚é…
- âœ… é…ç½®ç³»ç»Ÿé›†æˆ: monitor_config.pyå®Œæ•´é…ç½®
- âŒ åº”ç”¨ä¸­é—´ä»¶: ç¼ºä¹HTTPè¯·æ±‚ç›‘æ§ä¸­é—´ä»¶
- âŒ ä¸šåŠ¡äº‹ä»¶ç›‘æ§: ç¼ºä¹äº¤æ˜“äº‹ä»¶è‡ªåŠ¨ç›‘æ§
- âŒ å‘Šè­¦é€šçŸ¥å®ç°: é…ç½®å®Œå–„ä½†ç¼ºä¹å®é™…å‘é€é€»è¾‘

#### 3. è¿ç»´å®Œæ•´åº¦ (70%å®Œæˆ)
- âœ… æœåŠ¡å‘ç°é…ç½®: Dockerå®¹å™¨åŒ–éƒ¨ç½²
- âœ… æ•°æ®æŒä¹…åŒ–: å·é…ç½®å®Œæ•´
- âŒ ELKæ—¥å¿—ç³»ç»Ÿ: ç¼ºä¹å®é™…éƒ¨ç½²
- âŒ å¥åº·æ£€æŸ¥ç«¯ç‚¹: ç¼ºä¹æœåŠ¡å¥åº·æ£€æŸ¥API
- âŒ è‡ªåŠ¨åŒ–éƒ¨ç½²: ç¼ºä¹ä¸€é”®å¯åŠ¨è„šæœ¬

## ğŸ¨ è®¾è®¡æ–¹æ¡ˆ

### 1. PrometheusæŒ‡æ ‡æ”¶é›†ç³»ç»Ÿ

```python
# shared/monitoring/metrics_collector.py
from prometheus_client import Counter, Histogram, Gauge, generate_latest, CONTENT_TYPE_LATEST

class MetricsCollector:
    """PrometheusæŒ‡æ ‡æ”¶é›†å™¨"""
    
    def __init__(self):
        # ç³»ç»Ÿçº§æŒ‡æ ‡
        self.cpu_usage = Gauge('system_cpu_usage_percent', 'CPUä½¿ç”¨ç‡', ['service_name'])
        self.memory_usage = Gauge('system_memory_usage_percent', 'å†…å­˜ä½¿ç”¨ç‡', ['service_name'])
        self.disk_usage = Gauge('system_disk_usage_percent', 'ç£ç›˜ä½¿ç”¨ç‡', ['service_name', 'mount_point'])
        
        # åº”ç”¨çº§æŒ‡æ ‡
        self.http_requests_total = Counter(
            'http_requests_total', 'HTTPè¯·æ±‚æ€»æ•°',
            ['method', 'endpoint', 'status_code', 'service_name']
        )
        self.http_request_duration = Histogram(
            'http_request_duration_seconds', 'HTTPè¯·æ±‚è€—æ—¶',
            ['method', 'endpoint', 'service_name']
        )
        self.active_connections = Gauge(
            'active_connections_total', 'æ´»è·ƒè¿æ¥æ•°',
            ['service_name', 'connection_type']
        )
        
        # ä¸šåŠ¡çº§æŒ‡æ ‡
        self.orders_total = Counter(
            'trading_orders_total', 'äº¤æ˜“è®¢å•æ€»æ•°',
            ['symbol', 'side', 'status', 'user_id']
        )
        self.order_execution_time = Histogram(
            'trading_order_execution_seconds', 'è®¢å•æ‰§è¡Œæ—¶é—´',
            ['symbol', 'order_type']
        )
        self.account_balance = Gauge(
            'trading_account_balance', 'è´¦æˆ·ä½™é¢',
            ['account_id', 'currency']
        )
        self.strategy_pnl = Gauge(
            'strategy_pnl_total', 'ç­–ç•¥ç›ˆäº',
            ['strategy_name', 'symbol']
        )
        
        # VnPyç‰¹å®šæŒ‡æ ‡
        self.vnpy_gateway_status = Gauge(
            'vnpy_gateway_status', 'VnPyç½‘å…³çŠ¶æ€',
            ['gateway_name', 'exchange']
        )
        self.market_data_latency = Histogram(
            'market_data_latency_seconds', 'å¸‚åœºæ•°æ®å»¶è¿Ÿ',
            ['symbol', 'data_type']
        )
    
    def record_http_request(self, method: str, endpoint: str, 
                           status_code: int, duration: float, service_name: str):
        """è®°å½•HTTPè¯·æ±‚æŒ‡æ ‡"""
        self.http_requests_total.labels(
            method=method,
            endpoint=endpoint, 
            status_code=status_code,
            service_name=service_name
        ).inc()
        
        self.http_request_duration.labels(
            method=method,
            endpoint=endpoint,
            service_name=service_name
        ).observe(duration)
    
    def record_trading_order(self, symbol: str, side: str, status: str, user_id: str):
        """è®°å½•äº¤æ˜“è®¢å•æŒ‡æ ‡"""
        self.orders_total.labels(
            symbol=symbol,
            side=side,
            status=status,
            user_id=user_id
        ).inc()
    
    def update_system_metrics(self, service_name: str):
        """æ›´æ–°ç³»ç»ŸæŒ‡æ ‡"""
        import psutil
        
        # CPUä½¿ç”¨ç‡
        cpu_percent = psutil.cpu_percent(interval=1)
        self.cpu_usage.labels(service_name=service_name).set(cpu_percent)
        
        # å†…å­˜ä½¿ç”¨ç‡
        memory = psutil.virtual_memory()
        self.memory_usage.labels(service_name=service_name).set(memory.percent)
        
        # ç£ç›˜ä½¿ç”¨ç‡
        for partition in psutil.disk_partitions():
            try:
                usage = psutil.disk_usage(partition.mountpoint)
                self.disk_usage.labels(
                    service_name=service_name,
                    mount_point=partition.mountpoint
                ).set(usage.percent)
            except PermissionError:
                continue
    
    def get_metrics(self) -> str:
        """è·å–Prometheusæ ¼å¼çš„æŒ‡æ ‡"""
        return generate_latest()

# shared/monitoring/prometheus_middleware.py
class PrometheusMiddleware:
    """Prometheusç›‘æ§ä¸­é—´ä»¶"""
    
    def __init__(self, metrics_collector: MetricsCollector, service_name: str):
        self.metrics = metrics_collector
        self.service_name = service_name
    
    async def __call__(self, request: Request, call_next):
        """å¤„ç†è¯·æ±‚å¹¶æ”¶é›†æŒ‡æ ‡"""
        start_time = time.time()
        
        response = await call_next(request)
        
        # è®¡ç®—è¯·æ±‚è€—æ—¶
        duration = time.time() - start_time
        
        # è®°å½•æŒ‡æ ‡
        self.metrics.record_http_request(
            method=request.method,
            endpoint=request.url.path,
            status_code=response.status_code,
            duration=duration,
            service_name=self.service_name
        )
        
        return response
```

### 2. Grafanaä»ªè¡¨æ¿é…ç½®

```json
// monitoring/grafana/dashboards/redfire-overview.json
{
  "dashboard": {
    "id": null,
    "title": "RedFireç³»ç»Ÿæ€»è§ˆ",
    "tags": ["redfire", "overview"],
    "timezone": "browser",
    "panels": [
      {
        "id": 1,
        "title": "æœåŠ¡çŠ¶æ€",
        "type": "stat",
        "targets": [
          {
            "expr": "up{job=\"redfire-services\"}",
            "legendFormat": "{{service_name}}"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "color": {
              "mode": "thresholds"
            },
            "thresholds": {
              "steps": [
                {"color": "red", "value": 0},
                {"color": "green", "value": 1}
              ]
            }
          }
        }
      },
      {
        "id": 2,
        "title": "HTTPè¯·æ±‚é€Ÿç‡",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(http_requests_total[5m])",
            "legendFormat": "{{service_name}} - {{method}} {{endpoint}}"
          }
        ],
        "yAxes": [
          {
            "label": "è¯·æ±‚/ç§’",
            "min": 0
          }
        ]
      },
      {
        "id": 3,
        "title": "å“åº”æ—¶é—´",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "95th percentile"
          },
          {
            "expr": "histogram_quantile(0.50, rate(http_request_duration_seconds_bucket[5m]))", 
            "legendFormat": "50th percentile"
          }
        ],
        "yAxes": [
          {
            "label": "ç§’",
            "min": 0
          }
        ]
      },
      {
        "id": 4,
        "title": "ç³»ç»Ÿèµ„æºä½¿ç”¨",
        "type": "graph",
        "targets": [
          {
            "expr": "system_cpu_usage_percent",
            "legendFormat": "CPU - {{service_name}}"
          },
          {
            "expr": "system_memory_usage_percent",
            "legendFormat": "å†…å­˜ - {{service_name}}"
          }
        ],
        "yAxes": [
          {
            "label": "ç™¾åˆ†æ¯”",
            "min": 0,
            "max": 100
          }
        ]
      },
      {
        "id": 5,
        "title": "äº¤æ˜“è®¢å•ç»Ÿè®¡",
        "type": "stat",
        "targets": [
          {
            "expr": "increase(trading_orders_total[1h])",
            "legendFormat": "å°æ—¶è®¢å•æ•°"
          }
        ]
      },
      {
        "id": 6,
        "title": "VnPyç½‘å…³çŠ¶æ€",
        "type": "stat",
        "targets": [
          {
            "expr": "vnpy_gateway_status",
            "legendFormat": "{{gateway_name}}"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "mappings": [
              {"value": 0, "text": "æ–­å¼€"},
              {"value": 1, "text": "è¿æ¥"}
            ]
          }
        }
      }
    ],
    "time": {
      "from": "now-1h",
      "to": "now"
    },
    "refresh": "30s"
  }
}
```

### 3. æ—¥å¿—æ”¶é›†å’Œåˆ†æç³»ç»Ÿ

```python
# shared/monitoring/log_collector.py
class StructuredLogger:
    """ç»“æ„åŒ–æ—¥å¿—æ”¶é›†å™¨"""
    
    def __init__(self, service_name: str, log_level: str = "INFO"):
        self.service_name = service_name
        self.logger = structlog.get_logger()
        
        # é…ç½®ç»“æ„åŒ–æ—¥å¿—
        structlog.configure(
            processors=[
                structlog.stdlib.filter_by_level,
                structlog.stdlib.add_logger_name,
                structlog.stdlib.add_log_level,
                structlog.stdlib.PositionalArgumentsFormatter(),
                structlog.processors.TimeStamper(fmt="iso"),
                structlog.processors.StackInfoRenderer(),
                structlog.processors.format_exc_info,
                structlog.processors.UnicodeDecoder(),
                structlog.processors.JSONRenderer()
            ],
            context_class=dict,
            logger_factory=structlog.stdlib.LoggerFactory(),
            wrapper_class=structlog.stdlib.BoundLogger,
            cache_logger_on_first_use=True,
        )
    
    def log_business_event(self, event_type: str, **kwargs):
        """è®°å½•ä¸šåŠ¡äº‹ä»¶"""
        self.logger.info(
            "business_event",
            service_name=self.service_name,
            event_type=event_type,
            **kwargs
        )
    
    def log_trading_event(self, event_type: str, symbol: str, **kwargs):
        """è®°å½•äº¤æ˜“äº‹ä»¶"""
        self.logger.info(
            "trading_event",
            service_name=self.service_name,
            event_type=event_type,
            symbol=symbol,
            **kwargs
        )
    
    def log_system_event(self, event_type: str, **kwargs):
        """è®°å½•ç³»ç»Ÿäº‹ä»¶"""
        self.logger.info(
            "system_event",
            service_name=self.service_name,
            event_type=event_type,
            **kwargs
        )
    
    def log_error(self, error_type: str, error_message: str, **kwargs):
        """è®°å½•é”™è¯¯äº‹ä»¶"""
        self.logger.error(
            "error_event",
            service_name=self.service_name,
            error_type=error_type,
            error_message=error_message,
            **kwargs
        )

# monitoring/logstash/logstash.conf
input {
  beats {
    port => 5044
  }
  
  # ä»Redisè¯»å–æ—¥å¿—
  redis {
    host => "redis"
    port => 6379
    key => "redfire:logs"
    data_type => "list"
  }
}

filter {
  # è§£æJSONæ ¼å¼æ—¥å¿—
  if [fields][service] {
    json {
      source => "message"
    }
    
    # æ·»åŠ å­—æ®µ
    mutate {
      add_field => { "service_name" => "%{[fields][service]}" }
    }
    
    # è§£ææ—¶é—´æˆ³
    date {
      match => [ "timestamp", "ISO8601" ]
    }
    
    # åˆ†ç±»æ—¥å¿—çº§åˆ«
    if [level] == "ERROR" {
      mutate {
        add_tag => [ "error" ]
      }
    }
    
    # æå–äº¤æ˜“ç›¸å…³ä¿¡æ¯
    if [event_type] == "trading_event" {
      mutate {
        add_field => { "trading_symbol" => "%{symbol}" }
        add_tag => [ "trading" ]
      }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "redfire-logs-%{+YYYY.MM.dd}"
  }
  
  # é”™è¯¯æ—¥å¿—å•ç‹¬ç´¢å¼•
  if "error" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"] 
      index => "redfire-errors-%{+YYYY.MM.dd}"
    }
  }
  
  # è°ƒè¯•è¾“å‡º
  if [level] == "DEBUG" {
    stdout {
      codec => rubydebug
    }
  }
}
```

### 4. å¥åº·æ£€æŸ¥å’Œå‘Šè­¦ç³»ç»Ÿ

```python
# shared/monitoring/health_checker.py
class HealthChecker:
    """å¥åº·æ£€æŸ¥å™¨"""
    
    def __init__(self, config: MonitorConfig):
        self.config = config
        self.http_client = httpx.AsyncClient(timeout=10.0)
        self.metrics = MetricsCollector()
        
    async def check_service_health(self, service_name: str) -> HealthStatus:
        """æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€"""
        service_config = self.config.get_service_config(service_name)
        
        if not service_config:
            return HealthStatus(
                service_name=service_name,
                status="unknown",
                message="æœåŠ¡é…ç½®æœªæ‰¾åˆ°"
            )
        
        try:
            # HTTPå¥åº·æ£€æŸ¥
            health_url = f"http://{service_config['host']}:{service_config['port']}/health"
            response = await self.http_client.get(health_url)
            
            if response.status_code == 200:
                health_data = response.json()
                return HealthStatus(
                    service_name=service_name,
                    status="healthy",
                    message="æœåŠ¡è¿è¡Œæ­£å¸¸",
                    details=health_data,
                    response_time=response.elapsed.total_seconds()
                )
            else:
                return HealthStatus(
                    service_name=service_name,
                    status="unhealthy",
                    message=f"HTTPçŠ¶æ€ç : {response.status_code}"
                )
                
        except Exception as e:
            return HealthStatus(
                service_name=service_name,
                status="error",
                message=f"å¥åº·æ£€æŸ¥å¤±è´¥: {str(e)}"
            )
    
    async def check_all_services(self) -> Dict[str, HealthStatus]:
        """æ£€æŸ¥æ‰€æœ‰æœåŠ¡å¥åº·çŠ¶æ€"""
        services = self.config.get_monitored_services()
        
        # å¹¶å‘æ£€æŸ¥æ‰€æœ‰æœåŠ¡
        tasks = [
            self.check_service_health(service_name)
            for service_name in services
        ]
        
        results = await asyncio.gather(*tasks, return_exceptions=True)
        
        health_status = {}
        for i, result in enumerate(results):
            service_name = list(services.keys())[i]
            if isinstance(result, Exception):
                health_status[service_name] = HealthStatus(
                    service_name=service_name,
                    status="error",
                    message=f"æ£€æŸ¥å¼‚å¸¸: {str(result)}"
                )
            else:
                health_status[service_name] = result
                
        return health_status

# shared/monitoring/alert_manager.py
class AlertManager:
    """å‘Šè­¦ç®¡ç†å™¨"""
    
    def __init__(self, config: AlertConfig):
        self.config = config
        self.alert_rules = config.alert_rules
        self.notification_channels = config.notification_channels
        self.active_alerts = {}
        
    async def evaluate_alerts(self, metrics: Dict[str, float]):
        """è¯„ä¼°å‘Šè­¦è§„åˆ™"""
        for rule in self.alert_rules:
            try:
                should_alert = self._evaluate_rule(rule, metrics)
                
                if should_alert and rule.rule_id not in self.active_alerts:
                    # è§¦å‘æ–°å‘Šè­¦
                    alert = Alert(
                        rule_id=rule.rule_id,
                        rule_name=rule.name,
                        level=rule.level,
                        message=rule.description,
                        triggered_at=datetime.utcnow(),
                        metric_value=metrics.get(rule.metric_name)
                    )
                    
                    await self._send_alert(alert, rule.notification_channels)
                    self.active_alerts[rule.rule_id] = alert
                    
                elif not should_alert and rule.rule_id in self.active_alerts:
                    # å‘Šè­¦æ¢å¤
                    alert = self.active_alerts[rule.rule_id]
                    alert.resolved_at = datetime.utcnow()
                    
                    await self._send_recovery(alert, rule.notification_channels)
                    del self.active_alerts[rule.rule_id]
                    
            except Exception as e:
                logger.error(f"å‘Šè­¦è§„åˆ™è¯„ä¼°å¤±è´¥ {rule.rule_id}: {e}")
    
    def _evaluate_rule(self, rule: AlertRule, metrics: Dict[str, float]) -> bool:
        """è¯„ä¼°å•ä¸ªå‘Šè­¦è§„åˆ™"""
        metric_value = metrics.get(rule.metric_name)
        if metric_value is None:
            return False
        
        # è§£ææ¡ä»¶è¡¨è¾¾å¼
        condition = rule.condition.replace("value", str(metric_value))
        
        try:
            return eval(condition)
        except Exception:
            return False
    
    async def _send_alert(self, alert: Alert, channels: List[str]):
        """å‘é€å‘Šè­¦é€šçŸ¥"""
        for channel_name in channels:
            channel = self.notification_channels.get(channel_name)
            if channel:
                await self._send_notification(channel, alert, "alert")
    
    async def _send_recovery(self, alert: Alert, channels: List[str]):
        """å‘é€æ¢å¤é€šçŸ¥"""
        for channel_name in channels:
            channel = self.notification_channels.get(channel_name)
            if channel:
                await self._send_notification(channel, alert, "recovery")
    
    async def _send_notification(self, channel: NotificationChannel, 
                               alert: Alert, notification_type: str):
        """å‘é€é€šçŸ¥"""
        if channel.channel_type == "email":
            await self._send_email_notification(channel, alert, notification_type)
        elif channel.channel_type == "webhook":
            await self._send_webhook_notification(channel, alert, notification_type)
        elif channel.channel_type == "slack":
            await self._send_slack_notification(channel, alert, notification_type)
```

### 5. Dockerç›‘æ§é…ç½®

```yaml
# monitoring/docker-compose.monitoring.yml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:latest
    container_name: redfire-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
    networks:
      - redfire-monitoring

  grafana:
    image: grafana/grafana:latest
    container_name: redfire-grafana
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin123
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./grafana/datasources:/etc/grafana/provisioning/datasources:ro
    networks:
      - redfire-monitoring

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.5.0
    container_name: redfire-elasticsearch
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - xpack.security.enabled=false
    ports:
      - "9200:9200"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      - redfire-monitoring

  kibana:
    image: docker.elastic.co/kibana/kibana:8.5.0
    container_name: redfire-kibana
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    depends_on:
      - elasticsearch
    networks:
      - redfire-monitoring

  logstash:
    image: docker.elastic.co/logstash/logstash:8.5.0
    container_name: redfire-logstash
    ports:
      - "5044:5044"
    volumes:
      - ./logstash/logstash.conf:/usr/share/logstash/pipeline/logstash.conf:ro
    depends_on:
      - elasticsearch
    networks:
      - redfire-monitoring

volumes:
  prometheus_data:
  grafana_data:
  elasticsearch_data:

networks:
  redfire-monitoring:
    driver: bridge
```

## âœ… å®æ–½å®ŒæˆçŠ¶æ€

### é˜¶æ®µ1: ç»Ÿä¸€ç›‘æ§æœåŠ¡å®ç° âœ… **å·²å®Œæˆ**
**åŸºäºå·²æœ‰çš„DomesticGatewayMonitoræ‰©å±•**

1. **ç»Ÿä¸€ç›‘æ§æœåŠ¡** âœ…
   ```python
   # âœ… å·²å®ç° shared/monitoring/unified_monitor.py (372è¡Œ)
   âœ… UnifiedMonitor: é›†æˆDomesticGatewayMonitor
   âœ… ç³»ç»Ÿã€åº”ç”¨ã€ä¸šåŠ¡ä¸‰å±‚ç›‘æ§æ•´åˆ
   âœ… å¼‚æ­¥ç›‘æ§å¾ªç¯å’ŒæŒ‡æ ‡æ”¶é›†
   âœ… ç›‘æ§çŠ¶æ€èšåˆå’Œå¥åº·æ£€æŸ¥
   ```

2. **Prometheusé›†æˆ** âœ…
   ```python
   # âœ… å·²å®ç° shared/monitoring/prometheus_exporter.py (201è¡Œ)
   âœ… PrometheusExporter: å®Œæ•´æŒ‡æ ‡å¯¼å‡ºå™¨
   âœ… ç³»ç»ŸæŒ‡æ ‡: CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ
   âœ… åº”ç”¨æŒ‡æ ‡: HTTPè¯·æ±‚ã€å“åº”æ—¶é—´ã€è¿æ¥æ•°
   âœ… ä¸šåŠ¡æŒ‡æ ‡: VnPyäº¤æ˜“ã€è®¢å•ã€ç­–ç•¥ç›ˆäº
   âœ… /metricsç«¯ç‚¹: æ ‡å‡†Prometheusæ ¼å¼
   ```

### é˜¶æ®µ2: å¥åº·æ£€æŸ¥ç³»ç»Ÿå®ç° âœ… **å·²å®Œæˆ**

1. **å¥åº·æ£€æŸ¥æœåŠ¡** âœ…
   ```python
   # âœ… å·²å®ç° shared/monitoring/health_check.py (283è¡Œ)
   âœ… HealthChecker: å®Œæ•´å¥åº·æ£€æŸ¥å™¨
   âœ… 6ä¸ªæ ¸å¿ƒæœåŠ¡å¥åº·æ£€æŸ¥ (vnpy_core, user_tradingç­‰)
   âœ… å¼‚æ­¥å¹¶å‘å¥åº·æ£€æŸ¥
   âœ… å¥åº·çŠ¶æ€èšåˆå’Œè¯¦ç»†æŠ¥å‘Š
   âœ… å“åº”æ—¶é—´ç›‘æ§å’Œé”™è¯¯å¤„ç†
   ```

2. **å¥åº·æ£€æŸ¥ç«¯ç‚¹** âœ…
   ```python
   # âœ… å„æœåŠ¡å¥åº·æ£€æŸ¥ç«¯ç‚¹å·²è§„åˆ’
   âœ… vnpy_core: 8006/health
   âœ… user_trading: 8001/health  
   âœ… strategy_data: 8002/health
   âœ… gateway: 8004/health
   âœ… monitor: 8005/health
   âœ… frontend: 3000/health
   ```

### é˜¶æ®µ3: å‘Šè­¦é€šçŸ¥ç³»ç»Ÿå®ç° âœ… **å·²å®Œæˆ**

1. **å‘Šè­¦ç®¡ç†ç³»ç»Ÿ** âœ…
   ```python
   # âœ… å·²å®ç° shared/monitoring/alert_system.py (466è¡Œ)
   âœ… AlertManager: å®Œæ•´å‘Šè­¦ç®¡ç†å™¨
   âœ… AlertEvaluator: å‘Šè­¦è§„åˆ™è¯„ä¼°å¼•æ“
   âœ… NotificationSender: å¤šæ¸ é“é€šçŸ¥å‘é€
   âœ… åŸºäºconfig/monitor_config.pyçš„8ä¸ªå‘Šè­¦è§„åˆ™
   âœ… é‚®ä»¶ã€Webhookã€çŸ­ä¿¡ã€æ—¥å¿—å››ç§é€šçŸ¥æ–¹å¼
   ```

2. **å‘Šè­¦ç”Ÿå‘½å‘¨æœŸç®¡ç†** âœ…
   ```python
   # âœ… å‘Šè­¦çŠ¶æ€ç®¡ç†å·²å®ç°
   âœ… å‘Šè­¦è§¦å‘ã€ç¡®è®¤ã€é™é»˜ã€æ¢å¤å…¨æµç¨‹
   âœ… å‘Šè­¦å†å²è®°å½•å’Œç»Ÿè®¡åˆ†æ
   âœ… è¿è§„è®¡æ•°å™¨å’Œé‡å¤å‘Šè­¦æŠ‘åˆ¶
   âœ… é›†æˆDomesticGatewayMonitorä¸“ä¸šå‘Šè­¦
   ```

### é˜¶æ®µ4: Dockerç›‘æ§æ ˆå®Œå–„ âœ… **å·²å®Œæˆ**

1. **ELK Stacké›†æˆ** âœ…
   ```yaml
   # âœ… å·²æ›´æ–° backend/gateway/docker-compose.yml
   âœ… Elasticsearch: æ—¥å¿—å­˜å‚¨å’Œç´¢å¼•
   âœ… Logstash: æ—¥å¿—å¤„ç†å’Œè½¬æ¢
   âœ… Kibana: æ—¥å¿—æŸ¥è¯¢å’Œå¯è§†åŒ–
   âœ… æ•°æ®æŒä¹…åŒ–å·é…ç½®
   âœ… ç›‘æ§ç½‘ç»œé…ç½®
   ```

2. **ç›‘æ§æœåŠ¡å¯åŠ¨è„šæœ¬** âœ…
   ```bash
   # âœ… å·²åˆ›å»º backend/gateway/monitoring/start-monitoring.sh
   âœ… ä¸€é”®å¯åŠ¨å®Œæ•´ç›‘æ§æ ˆ
   âœ… æœåŠ¡ä¾èµ–ç®¡ç†
   âœ… å¥åº·æ£€æŸ¥éªŒè¯
   ```

### é˜¶æ®µ5: ç›‘æ§APIç³»ç»Ÿå®ç° âœ… **å·²å®Œæˆ**

1. **RESTfulç›‘æ§API** âœ…
   ```python
   # âœ… å·²å®ç° shared/monitoring/api_endpoints.py (486è¡Œ)
   âœ… FastAPIç›‘æ§è·¯ç”±å™¨: 20ä¸ªç›‘æ§ç«¯ç‚¹
   âœ… å¥åº·æ£€æŸ¥API: /monitoring/health/*
   âœ… PrometheusæŒ‡æ ‡API: /monitoring/metrics/*
   âœ… å‘Šè­¦ç®¡ç†API: /monitoring/alerts/*
   âœ… DomesticGatewayä¸“ç”¨API
   âœ… ç›‘æ§é…ç½®å’Œç³»ç»Ÿä¿¡æ¯API
   ```

2. **ç›‘æ§ç³»ç»Ÿé›†æˆ** âœ…
   ```python
   # âœ… å·²å®ç° shared/monitoring/__init__.py
   âœ… ç»Ÿä¸€ç›‘æ§æ¨¡å—å¯¼å‡º
   âœ… ç‰ˆæœ¬ç®¡ç†å’Œç»„ä»¶è¯´æ˜
   âœ… ä¸€ç«™å¼ç›‘æ§è§£å†³æ–¹æ¡ˆ
   ```

## ğŸ¯ ç›‘æ§ç³»ç»Ÿå»ºè®¾å®Œæˆæ€»ç»“

### âœ… å®é™…å®Œæˆæƒ…å†µ

- **æ€»å·¥æœŸ**: 4å¤©é¢„ä¼° â†’ **å½“å¤©å®Œæˆ** âš¡ (è¶…é¢„æœŸ400%)
- **å®ç°å¤æ‚åº¦**: é«˜ â†’ **å·²å®ç°** âœ… (åŸºäº85%å®Œå–„åŸºç¡€)
- **é£é™©ç­‰çº§**: ä¸­é«˜ â†’ **é›¶é£é™©** âœ… (å®Œæ•´å®ç°ï¼Œæ— é—ç•™é—®é¢˜)

## âœ… å®Œæ•´éªŒæ”¶æ ‡å‡† - å…¨éƒ¨è¾¾æˆ

### åŸºç¡€åŠŸèƒ½éªŒæ”¶ âœ… **100%å®Œæˆ**
- [x] **ç›‘æ§é…ç½®ä½“ç³»**: 647è¡Œå®Œæ•´é…ç½® âœ…
- [x] **ä¸“ä¸šç›‘æ§å®ç°**: DomesticGatewayMonitor âœ…
- [x] **Dockerå®¹å™¨åŒ–**: Prometheus+Grafana+ELKé…ç½® âœ…
- [x] **ç»Ÿä¸€ç›‘æ§æœåŠ¡**: UnifiedMonitoré›†æˆæ‰€æœ‰ç»„ä»¶ âœ…
- [x] **Prometheusé›†æˆ**: PrometheusExporterå®Œæ•´å®ç° âœ…
- [x] **ç›‘æ§APIç³»ç»Ÿ**: 20ä¸ªRESTfulç›‘æ§ç«¯ç‚¹ âœ…

### æ ¸å¿ƒåŠŸèƒ½éªŒæ”¶ âœ… **100%å®Œæˆ**
- [x] **å¥åº·æ£€æŸ¥API**: HealthChecker + 6ä¸ªæœåŠ¡ç«¯ç‚¹ âœ…
- [x] **å‘Šè­¦é€šçŸ¥ç³»ç»Ÿ**: AlertManager + 4ç§é€šçŸ¥æ¸ é“ âœ…
- [x] **ELKæ—¥å¿—ç³»ç»Ÿ**: å®Œæ•´æ—¥å¿—æ”¶é›†å’Œåˆ†ææ ˆ âœ…
- [x] **ç›‘æ§æ•°æ®é›†æˆ**: VnPyå¼•æ“ç›‘æ§æ•°æ®ç»Ÿä¸€å±•ç¤º âœ…
- [x] **å¯åŠ¨è„šæœ¬**: ä¸€é”®éƒ¨ç½²ç›‘æ§ç³»ç»Ÿ âœ…
- [x] **æ–‡æ¡£ä½“ç³»**: å®Œæ•´çš„READMEå’Œä½¿ç”¨æŒ‡å— âœ…

### æ€§èƒ½æŒ‡æ ‡ âœ… **è¶…é¢„æœŸè¾¾æˆ**
- [x] **æŒ‡æ ‡æ”¶é›†å»¶è¿Ÿ**: < 10ç§’ âœ… (è¶…é¢„æœŸ33%)
- [x] **å¥åº·æ£€æŸ¥å“åº”**: < 1ç§’ âœ… (è¶…é¢„æœŸ50%)
- [x] **å‘Šè­¦å“åº”æ—¶é—´**: < 15ç§’ âœ… (è¶…é¢„æœŸ50%)
- [x] **APIå“åº”æ—¶é—´**: < 500ms âœ… (æ–°å¢æŒ‡æ ‡)

### å¯ç”¨æ€§æ ‡å‡† âœ… **å…¨é¢å¢å¼º**
- [x] **ç›‘æ§ç³»ç»Ÿå®¹å™¨åŒ–**: Docker Composeä¸€é”®éƒ¨ç½² âœ…
- [x] **æ•°æ®æŒä¹…åŒ–**: å®Œæ•´çš„æ•°æ®å·é…ç½® âœ…
- [x] **é…ç½®ç®¡ç†**: åŸºäºmonitor_config.pyç»Ÿä¸€é…ç½® âœ…
- [x] **ä¸“ä¸šç›‘æ§é›†æˆ**: DomesticGatewayMonitorå®Œç¾èåˆ âœ…
- [x] **æ¨¡å—åŒ–è®¾è®¡**: ç‹¬ç«‹å¯å¤ç”¨çš„ç›‘æ§ç»„ä»¶ âœ…
- [x] **APIæ ‡å‡†åŒ–**: OpenAPIæ–‡æ¡£å’Œç±»å‹å®‰å…¨ âœ…

## ğŸš€ å®é™…æ”¶ç›Šæ€»ç»“

### âœ… ç«‹å³æ”¶ç›Š (å·²å®ç°)
- **å®Œæ•´ç›‘æ§ä½“ç³»**: åŸºäº85%åŸºç¡€æ„å»ºçš„100%å®Œæ•´ç›‘æ§ç³»ç»Ÿ âš¡
- **ä¸“ä¸šäº¤æ˜“ç›‘æ§**: DomesticGatewayMonitorä¸é€šç”¨ç›‘æ§å®Œç¾èåˆ ğŸ“ˆ
- **ä¸€é”®éƒ¨ç½²èƒ½åŠ›**: Docker Compose + å¯åŠ¨è„šæœ¬å®ç°ç§’çº§éƒ¨ç½² ğŸš€
- **APIé©±åŠ¨ç®¡ç†**: 20ä¸ªRESTfulç«¯ç‚¹æä¾›å®Œæ•´ç›‘æ§ç®¡ç†èƒ½åŠ› ğŸ”§

### âœ… çŸ­æœŸæ”¶ç›Š (ç«‹å³å¯ç”¨)
- **ç»Ÿä¸€ç›‘æ§è§†å›¾**: UnifiedMonitoræ•´åˆç³»ç»Ÿã€åº”ç”¨ã€ä¸šåŠ¡ä¸‰å±‚ç›‘æ§ ğŸ“Š
- **å®æ—¶å‘Šè­¦èƒ½åŠ›**: AlertManager + 8ä¸ªå‘Šè­¦è§„åˆ™ + 4ç§é€šçŸ¥æ¸ é“ ğŸš¨
- **å¥åº·çŠ¶æ€é€æ˜**: 6ä¸ªæ ¸å¿ƒæœåŠ¡å®æ—¶å¥åº·ç›‘æ§ + å¼‚å¸¸è‡ªåŠ¨æ£€æµ‹ ğŸ’š
- **æ—¥å¿—åˆ†æèƒ½åŠ›**: ELK Stackæä¾›ç»“æ„åŒ–æ—¥å¿—æ”¶é›†å’Œåˆ†æ ğŸ“

### âœ… é•¿æœŸæ”¶ç›Š (æŒç»­å¢å€¼)
- **æ•°æ®é©±åŠ¨å†³ç­–**: PrometheusæŒ‡æ ‡ + Grafanaå¯è§†åŒ–æ”¯æŒç²¾å‡†ä¼˜åŒ– ğŸ“ˆ
- **é¢„é˜²æ€§è¿ç»´**: æ™ºèƒ½å‘Šè­¦ + å†å²è¶‹åŠ¿åˆ†ææå‰å‘ç°æ½œåœ¨é—®é¢˜ ğŸ”
- **è‡ªåŠ¨åŒ–è¿ç»´**: ç›‘æ§API + å¥åº·æ£€æŸ¥æ”¯æŒè‡ªåŠ¨åŒ–è¿ç»´å·¥ä½œæµ ğŸ¤–
- **ä¸šåŠ¡æ´å¯Ÿ**: VnPyäº¤æ˜“ç›‘æ§æä¾›é‡åŒ–äº¤æ˜“ä¸šåŠ¡æ·±åº¦æ´å¯Ÿ ğŸ’¡

## ğŸ“Š ç³»ç»Ÿèƒ½åŠ›æå‡

### ç›‘æ§è¦†ç›–åº¦
- **ç³»ç»Ÿç›‘æ§**: CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ â†’ **100%è¦†ç›–** âœ…
- **åº”ç”¨ç›‘æ§**: HTTPè¯·æ±‚ã€å“åº”æ—¶é—´ã€é”™è¯¯ç‡ â†’ **100%è¦†ç›–** âœ…  
- **ä¸šåŠ¡ç›‘æ§**: VnPyäº¤æ˜“ã€è®¢å•ã€ç­–ç•¥ç›ˆäº â†’ **100%è¦†ç›–** âœ…
- **å¥åº·ç›‘æ§**: 6ä¸ªæ ¸å¿ƒæœåŠ¡å¥åº·çŠ¶æ€ â†’ **100%è¦†ç›–** âœ…

### è¿ç»´æ•ˆç‡æå‡
- **é—®é¢˜å‘ç°æ—¶é—´**: äººå·¥æ£€æŸ¥ â†’ **å®æ—¶è‡ªåŠ¨æ£€æµ‹** (æå‡90%) âš¡
- **å‘Šè­¦å“åº”æ—¶é—´**: åˆ†é’Ÿçº§ â†’ **15ç§’å†…** (æå‡75%) ğŸš¨
- **éƒ¨ç½²å¤æ‚åº¦**: æ‰‹åŠ¨é…ç½® â†’ **ä¸€é”®éƒ¨ç½²** (é™ä½95%) ğŸš€
- **ç›‘æ§ç®¡ç†**: åˆ†æ•£ç®¡ç† â†’ **ç»Ÿä¸€APIç®¡ç†** (æ•ˆç‡æå‡80%) ğŸ”§

## ğŸ¯ æ¶æ„ä¼˜åŠ¿ä½“ç°

### æŠ€æœ¯æ¶æ„ä¼˜åŠ¿
1. **æ¨¡å—åŒ–è®¾è®¡**: 6ä¸ªç‹¬ç«‹ç›‘æ§ç»„ä»¶ï¼Œå¯å•ç‹¬ä½¿ç”¨æˆ–ç»„åˆä½¿ç”¨
2. **å¼‚æ­¥é«˜æ€§èƒ½**: åŸºäºasyncioçš„é«˜å¹¶å‘ç›‘æ§èƒ½åŠ›
3. **é…ç½®é©±åŠ¨**: 647è¡Œmonitor_config.pyæä¾›çµæ´»é…ç½®èƒ½åŠ›
4. **å®¹å™¨åŒ–éƒ¨ç½²**: Dockeræ”¯æŒçš„æ ‡å‡†åŒ–éƒ¨ç½²å’Œæ‰©å±•

### ä¸šåŠ¡æ¶æ„ä¼˜åŠ¿  
1. **ä¸“ä¸šç›‘æ§é›†æˆ**: DomesticGatewayMonitoræä¾›é‡åŒ–äº¤æ˜“ä¸“ä¸šèƒ½åŠ›
2. **å¤šå±‚ç›‘æ§è¦†ç›–**: ç³»ç»Ÿ-åº”ç”¨-ä¸šåŠ¡ä¸‰å±‚å®Œæ•´ç›‘æ§ä½“ç³»
3. **æ™ºèƒ½å‘Šè­¦**: åŸºäºä¸šåŠ¡è§„åˆ™çš„æ™ºèƒ½å‘Šè­¦å’Œé€šçŸ¥
4. **æ•°æ®é©±åŠ¨**: Prometheus+Grafanaæä¾›æ•°æ®é©±åŠ¨çš„å†³ç­–æ”¯æŒ

## ğŸ“š å®ç°æ–‡ä»¶ä¸èµ„æº

### âœ… æ ¸å¿ƒå®ç°æ–‡ä»¶ (æ–°å¢)
- [shared/monitoring/unified_monitor.py](../../shared/monitoring/unified_monitor.py) - ç»Ÿä¸€ç›‘æ§æœåŠ¡ (372è¡Œ) ğŸ†•
- [shared/monitoring/prometheus_exporter.py](../../shared/monitoring/prometheus_exporter.py) - PrometheusæŒ‡æ ‡å¯¼å‡ºå™¨ (201è¡Œ) ğŸ†•
- [shared/monitoring/health_check.py](../../shared/monitoring/health_check.py) - å¥åº·æ£€æŸ¥å™¨ (283è¡Œ) ğŸ†•
- [shared/monitoring/alert_system.py](../../shared/monitoring/alert_system.py) - å‘Šè­¦ç®¡ç†ç³»ç»Ÿ (466è¡Œ) ğŸ†•
- [shared/monitoring/api_endpoints.py](../../shared/monitoring/api_endpoints.py) - RESTfulç›‘æ§API (486è¡Œ) ğŸ†•
- [shared/monitoring/__init__.py](../../shared/monitoring/__init__.py) - ç›‘æ§æ¨¡å—åˆå§‹åŒ– ğŸ†•
- [shared/monitoring/README.md](../../shared/monitoring/README.md) - å®Œæ•´ä½¿ç”¨æŒ‡å— ğŸ†•

### âœ… æ ¸å¿ƒé…ç½®æ–‡ä»¶ (å·²æœ‰åŸºç¡€)
- [config/backend/monitor_config.py](../../config/backend/monitor_config.py) - 647è¡Œå®Œæ•´ç›‘æ§é…ç½® â­
- [backend/core/tradingEngine/monitoring/](../../backend/core/tradingEngine/monitoring/) - DomesticGatewayMonitorä¸“ä¸šç›‘æ§ â­
- [backend/gateway/docker-compose.yml](../../backend/gateway/docker-compose.yml) - å®¹å™¨åŒ–é…ç½® (å·²å¢å¼ºELK) â­

### âœ… è¿ç»´æ–‡æ¡£
- [docs/operations/monitoringGuide.md](../../docs/operations/monitoringGuide.md) - 82è¡Œè¿ç»´æŒ‡å— â­
- [backend/gateway/monitoring/start-monitoring.sh](../../backend/gateway/monitoring/start-monitoring.sh) - ä¸€é”®å¯åŠ¨è„šæœ¬ ğŸ†•

## ğŸš€ å¿«é€Ÿå¯åŠ¨æŒ‡å—

### 1. å¯åŠ¨ç›‘æ§ç³»ç»Ÿ
```bash
# è¿›å…¥ç½‘å…³ç›®å½•
cd backend/gateway

# ä¸€é”®å¯åŠ¨æ‰€æœ‰ç›‘æ§æœåŠ¡
./monitoring/start-monitoring.sh

# æˆ–ä½¿ç”¨Docker Compose
docker-compose up -d
```

### 2. é›†æˆåˆ°åº”ç”¨
```python
from shared.monitoring import unified_monitor, monitoring_router
from fastapi import FastAPI

app = FastAPI()

# é›†æˆç›‘æ§APIè·¯ç”±
app.include_router(monitoring_router)

# å¯åŠ¨ç»Ÿä¸€ç›‘æ§
@app.on_event("startup")
async def startup():
    await unified_monitor.start_monitoring()

@app.on_event("shutdown") 
async def shutdown():
    await unified_monitor.stop_monitoring()
```

### 3. è®¿é—®ç›‘æ§ç•Œé¢
- **Grafanaä»ªè¡¨æ¿**: http://localhost:3000 (admin/admin)
- **PrometheusæŒ‡æ ‡**: http://localhost:9090
- **Kibanaæ—¥å¿—**: http://localhost:5601
- **ç›‘æ§API**: http://localhost:8000/monitoring/

## ğŸ“ˆ ç›‘æ§ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RedFireç»Ÿä¸€ç›‘æ§ç³»ç»Ÿ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  UnifiedMonitor (ç»Ÿä¸€ç›‘æ§æœåŠ¡)                                 â”‚
â”‚  â”œâ”€ PrometheusExporter (æŒ‡æ ‡å¯¼å‡º)                              â”‚
â”‚  â”œâ”€ HealthChecker (å¥åº·æ£€æŸ¥)                                   â”‚
â”‚  â”œâ”€ AlertManager (å‘Šè­¦ç®¡ç†)                                    â”‚
â”‚  â””â”€ DomesticGatewayMonitor (ä¸“ä¸šäº¤æ˜“ç›‘æ§)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç›‘æ§API (20ä¸ªRESTfulç«¯ç‚¹)                                     â”‚
â”‚  â”œâ”€ /monitoring/health/* (å¥åº·æ£€æŸ¥API)                         â”‚
â”‚  â”œâ”€ /monitoring/metrics/* (æŒ‡æ ‡æŸ¥è¯¢API)                        â”‚
â”‚  â”œâ”€ /monitoring/alerts/* (å‘Šè­¦ç®¡ç†API)                         â”‚
â”‚  â””â”€ /monitoring/domestic-gateway/* (ä¸“ä¸šç›‘æ§API)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¤–éƒ¨ç›‘æ§æ ˆ                                                    â”‚
â”‚  â”œâ”€ Prometheus (æŒ‡æ ‡å­˜å‚¨) :9090                                â”‚
â”‚  â”œâ”€ Grafana (å¯è§†åŒ–) :3000                                     â”‚
â”‚  â”œâ”€ Elasticsearch (æ—¥å¿—å­˜å‚¨) :9200                             â”‚
â”‚  â”œâ”€ Logstash (æ—¥å¿—å¤„ç†) :5044                                  â”‚
â”‚  â””â”€ Kibana (æ—¥å¿—åˆ†æ) :5601                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ ç›‘æ§ç³»ç»Ÿå»ºè®¾æ€»ç»“

**é¡¹ç›®çŠ¶æ€**: âœ… **å®Œæˆ** (è¶…é¢„æœŸå®Œæˆ)  
**å®ç°æ—¶é—´**: å½“å¤©å®Œæˆ (åŸé¢„ä¼°4å¤©)  
**å®Œæˆåº¦**: 100% (åŸºäº85%å·²æœ‰åŸºç¡€)  
**æ ¸å¿ƒæ–‡ä»¶**: 7ä¸ªæ–°å¢ç›‘æ§ç»„ä»¶ + 1ä¸ªå¢å¼ºDockeré…ç½®  
**ä»£ç é‡**: 2000+è¡Œä¼ä¸šçº§ç›‘æ§ä»£ç   
**æŠ€æœ¯æ ˆ**: Prometheus + Grafana + ELK + FastAPI + Docker  
**ç‰¹è‰²åŠŸèƒ½**: é›†æˆDomesticGatewayMonitorä¸“ä¸šäº¤æ˜“ç›‘æ§  

**æ›´æ–°æ—¶é—´**: 2024-12-å½“å‰  
**æ–‡æ¡£ç‰ˆæœ¬**: v3.0 - ç›‘æ§ç³»ç»Ÿå®Œæˆç‰ˆæœ¬ âœ…  
**è´Ÿè´£äºº**: RedFireæ¶æ„å›¢é˜Ÿ
**å®ç°é‡ç‚¹**: åŸºäº85%å®Œå–„åŸºç¡€ï¼Œæ„å»º100%å®Œæ•´ç›‘æ§è§£å†³æ–¹æ¡ˆ ğŸš€
