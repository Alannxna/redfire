# 🐳 TODO-03: 微服务容器化部署

## 🎯 任务概述

**任务ID**: micro_01  
**优先级**: 高  
**预估工期**: 4-5天  
**负责模块**: 微服务架构

### 问题描述
当前RedFire项目需要为5个微服务创建完整的Docker配置和docker-compose编排，实现标准化的容器化部署。

## 🔍 现状分析

### 现有Docker配置

#### 1. 后端Dockerfile分析
```dockerfile
# backend/Dockerfile - 现有配置
FROM python:3.11-slim as base

# 多阶段构建配置
FROM base as development
FROM base as production  
FROM python:3.11-alpine as lightweight

# 问题:
# - 缺乏微服务特定配置
# - 依赖安装效率低
# - 镜像体积较大
```

#### 2. Docker Compose现状
```yaml
# deployment/docker/docker-compose.yml - 现有配置
services:
  postgres:
    image: postgres:15-alpine
  redis:
    image: redis:7-alpine
  backend:
    build: ../../backend
    ports: ["8000:8000"]
  frontend:
    build: ../../frontend/web-app

# 问题:
# - 没有微服务拆分
# - 缺乏服务发现配置
# - 网络隔离不完善
```

### 微服务端口配置

根据代码分析，系统定义了5个微服务：

```python
# config/backend/service_config.py
vnpy_core_port: int = 8006      # VnPy核心服务
user_trading_port: int = 8001   # 用户交易服务  
strategy_data_port: int = 8002  # 策略数据服务
gateway_port: int = 8004        # 网关适配服务
monitor_port: int = 8005        # 监控通知服务
```

### 代码质量问题

#### 1. 构建效率低
- Python依赖重复安装
- 缺乏分层缓存优化
- 镜像构建时间长

#### 2. 配置管理混乱
- 环境变量配置分散
- 服务间依赖不明确
- 健康检查不完善

#### 3. 安全问题
- 容器以root用户运行
- 暴露不必要端口
- 缺乏安全扫描

## 🎨 设计方案

### 1. 微服务Dockerfile标准化

```dockerfile
# deployment/docker/services/base/Dockerfile
FROM python:3.11-slim as base

# 设置环境变量
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONPATH=/app \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    build-essential \
    libpq-dev \
    curl \
    && rm -rf /var/lib/apt/lists/*

# 创建非root用户
RUN useradd --create-home --shell /bin/bash redfire
WORKDIR /app
RUN chown redfire:redfire /app
USER redfire

# 安装Python依赖
COPY requirements.txt .
RUN pip install --user -r requirements.txt

# ===============================
# VnPy核心服务
# ===============================
FROM base as vnpy-core-service

LABEL maintainer="RedFire Team" \
      service="vnpy-core" \
      version="1.0.0"

# 复制服务特定代码
COPY --chown=redfire:redfire ./services/vnpy-core/ ./
COPY --chown=redfire:redfire ./shared/ ./shared/

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:8006/health || exit 1

EXPOSE 8006

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8006"]

# ===============================  
# 用户交易服务
# ===============================
FROM base as user-trading-service

LABEL maintainer="RedFire Team" \
      service="user-trading" \
      version="1.0.0"

COPY --chown=redfire:redfire ./services/user-trading/ ./
COPY --chown=redfire:redfire ./shared/ ./shared/

HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:8001/health || exit 1

EXPOSE 8001

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8001"]
```

### 2. 服务特定Dockerfile

```dockerfile
# deployment/docker/services/strategy-data/Dockerfile
FROM redfire/base:latest

LABEL service="strategy-data"

# 安装策略数据服务特定依赖
COPY requirements-strategy.txt .
RUN pip install --user -r requirements-strategy.txt

# 复制服务代码
COPY --chown=redfire:redfire ./services/strategy-data/ ./

# 创建数据目录
RUN mkdir -p data/strategies data/backtest data/reports

HEALTHCHECK --interval=60s --timeout=15s --start-period=45s --retries=2 \
    CMD curl -f http://localhost:8002/health || exit 1

EXPOSE 8002

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8002"]

# deployment/docker/services/gateway/Dockerfile  
FROM redfire/base:latest

LABEL service="gateway-adapter"

# 网关服务特定配置
COPY --chown=redfire:redfire ./services/gateway/ ./
COPY --chown=redfire:redfire ./adapters/ ./adapters/

# 安装交易接口依赖
RUN pip install --user vnpy[ctp] vnpy[ib] vnpy[okex]

HEALTHCHECK --interval=45s --timeout=20s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8004/health || exit 1

EXPOSE 8004

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8004"]
```

### 3. 完整Docker Compose编排

```yaml
# deployment/docker/docker-compose.yml
version: '3.8'

# ====================== 网络配置 ======================
networks:
  redfire-frontend:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
  redfire-backend:
    driver: bridge  
    internal: true
    ipam:
      config:
        - subnet: 172.21.0.0/24
  redfire-data:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.22.0.0/24

# ====================== 卷配置 ======================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  influxdb_data:
    driver: local
  mongo_data:
    driver: local
  vnpy_data:
    driver: local
  logs_data:
    driver: local

# ====================== 服务配置 ======================
services:
  
  # ----- 数据库层 -----
  postgres:
    image: postgres:15-alpine
    container_name: redfire-postgres
    environment:
      POSTGRES_DB: redfire
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d:ro
    networks:
      - redfire-data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d redfire"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  redis:
    image: redis:7-alpine
    container_name: redfire-redis
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    networks:
      - redfire-data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  influxdb:
    image: influxdb:2.7-alpine
    container_name: redfire-influxdb
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: ${INFLUX_USER}
      DOCKER_INFLUXDB_INIT_PASSWORD: ${INFLUX_PASSWORD}
      DOCKER_INFLUXDB_INIT_ORG: redfire
      DOCKER_INFLUXDB_INIT_BUCKET: market_data
    volumes:
      - influxdb_data:/var/lib/influxdb2
    networks:
      - redfire-data
    restart: unless-stopped

  mongodb:
    image: mongo:7.0
    container_name: redfire-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
      MONGO_INITDB_DATABASE: redfire_logs
    volumes:
      - mongo_data:/data/db
    networks:
      - redfire-data
    restart: unless-stopped

  # ----- VnPy核心服务 -----
  vnpy-core:
    build:
      context: ../../backend
      dockerfile: deployment/docker/services/vnpy-core/Dockerfile
      target: vnpy-core-service
    container_name: redfire-vnpy-core
    environment:
      - SERVICE_NAME=vnpy_core
      - SERVICE_PORT=8006
      - DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@postgres:5432/redfire
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - ENVIRONMENT=${ENVIRONMENT:-production}
    volumes:
      - vnpy_data:/app/data
      - logs_data:/app/logs
    networks:
      - redfire-backend
      - redfire-data
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M

  # ----- 用户交易服务 -----  
  user-trading:
    build:
      context: ../../backend
      dockerfile: deployment/docker/services/user-trading/Dockerfile
      target: user-trading-service
    container_name: redfire-user-trading
    environment:
      - SERVICE_NAME=user_trading
      - SERVICE_PORT=8001
      - DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@postgres:5432/redfire
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/1
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
    networks:
      - redfire-backend
      - redfire-data
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      vnpy-core:
        condition: service_healthy
    restart: unless-stopped

  # ----- 策略数据服务 -----
  strategy-data:
    build:
      context: ../../backend  
      dockerfile: deployment/docker/services/strategy-data/Dockerfile
    container_name: redfire-strategy-data
    environment:
      - SERVICE_NAME=strategy_data
      - SERVICE_PORT=8002
      - DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@postgres:5432/redfire
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUX_TOKEN}
    networks:
      - redfire-backend
      - redfire-data
    depends_on:
      postgres:
        condition: service_healthy
      influxdb:
        condition: service_started
    restart: unless-stopped

  # ----- 网关适配服务 -----
  gateway-adapter:
    build:
      context: ../../backend
      dockerfile: deployment/docker/services/gateway/Dockerfile
    container_name: redfire-gateway
    environment:
      - SERVICE_NAME=gateway
      - SERVICE_PORT=8004
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/2
    volumes:
      - vnpy_data:/app/data:ro
    networks:
      - redfire-backend
      - redfire-data
    depends_on:
      redis:
        condition: service_healthy
      vnpy-core:
        condition: service_healthy
    restart: unless-stopped

  # ----- 监控通知服务 -----
  monitor-service:
    build:
      context: ../../backend
      dockerfile: deployment/docker/services/monitor/Dockerfile
    container_name: redfire-monitor
    environment:
      - SERVICE_NAME=monitor
      - SERVICE_PORT=8005
      - MONGO_URL=mongodb://${MONGO_USER}:${MONGO_PASSWORD}@mongodb:27017/redfire_logs
      - ALERT_WEBHOOK_URL=${ALERT_WEBHOOK_URL}
    volumes:
      - logs_data:/app/logs:ro
    networks:
      - redfire-backend
      - redfire-data
    depends_on:
      mongodb:
        condition: service_started
    restart: unless-stopped

  # ----- API网关 -----
  api-gateway:
    image: nginx:alpine
    container_name: redfire-api-gateway
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    networks:
      - redfire-frontend
      - redfire-backend
    depends_on:
      - user-trading
      - vnpy-core
      - strategy-data
      - gateway-adapter
      - monitor-service
    restart: unless-stopped
```

### 4. 环境配置文件

```bash
# deployment/docker/.env.production
# 数据库配置
DB_USER=redfire_prod
DB_PASSWORD=secure_db_password_2024
DB_NAME=redfire

# Redis配置  
REDIS_PASSWORD=secure_redis_password_2024

# InfluxDB配置
INFLUX_USER=redfire_influx
INFLUX_PASSWORD=secure_influx_password_2024
INFLUX_TOKEN=influx_api_token_2024

# MongoDB配置
MONGO_USER=redfire_mongo
MONGO_PASSWORD=secure_mongo_password_2024

# 应用配置
JWT_SECRET_KEY=super_secure_jwt_key_2024_32_chars_long
ENVIRONMENT=production
ALERT_WEBHOOK_URL=https://hooks.slack.com/services/...

# 服务发现
SERVICE_REGISTRY_URL=http://consul:8500
```

## 🔧 实施步骤

### 阶段1: 基础镜像构建 (1天)

1. **创建服务目录结构**
   ```bash
   mkdir -p deployment/docker/services/{vnpy-core,user-trading,strategy-data,gateway,monitor}
   mkdir -p backend/services/{vnpy-core,user-trading,strategy-data,gateway,monitor}
   ```

2. **构建基础镜像**
   ```bash
   cd deployment/docker
   docker build -f Dockerfile.base -t redfire/base:latest .
   ```

### 阶段2: 微服务拆分 (2天)

1. **重构现有代码为微服务**
   - 将monolith代码拆分到各服务目录
   - 实现服务间通信接口
   - 配置服务特定依赖

2. **服务健康检查端点**
   ```python
   # 每个服务添加健康检查
   @app.get("/health")
   async def health_check():
       return {
           "status": "healthy",
           "service": os.getenv("SERVICE_NAME"),
           "timestamp": datetime.utcnow().isoformat()
       }
   ```

### 阶段3: 编排配置 (1天)

1. **Docker Compose配置**
   - 网络隔离配置
   - 卷挂载优化
   - 资源限制设置

2. **Nginx反向代理**
   ```nginx
   # deployment/docker/nginx/nginx.conf
   upstream vnpy_core {
       server vnpy-core:8006;
   }
   
   upstream user_trading {
       server user-trading:8001;
   }
   
   server {
       listen 80;
       
       location /api/v1/auth/ {
           proxy_pass http://user_trading;
       }
       
       location /api/v1/trading/ {
           proxy_pass http://vnpy_core;
       }
   }
   ```

### 阶段4: 生产优化 (1天)

1. **镜像优化**
   - 多阶段构建优化
   - 依赖层缓存
   - 镜像体积压缩

2. **安全加固**
   ```dockerfile
   # 安全扫描
   RUN apk add --no-cache dumb-init
   ENTRYPOINT ["dumb-init", "--"]
   
   # 非root用户
   USER redfire
   
   # 只暴露必要端口
   EXPOSE 8001
   ```

## 📊 验收标准

### 功能验收
- [ ] 5个微服务独立启动成功
- [ ] 服务间通信正常
- [ ] 数据库连接池工作正常
- [ ] API网关路由正确

### 性能指标  
- [ ] 容器启动时间 < 30秒
- [ ] 镜像大小 < 500MB
- [ ] 内存使用优化
- [ ] CPU使用效率

### 安全标准
- [ ] 容器非root用户运行
- [ ] 网络隔离正确配置
- [ ] 敏感信息环境变量化
- [ ] 健康检查完善

## 🚨 风险评估

### 高风险
- **服务拆分**: 可能破坏现有功能
- **数据一致性**: 微服务间数据同步问题

### 中风险
- **性能影响**: 网络通信开销
- **运维复杂度**: 容器管理复杂化

### 缓解措施
1. **灰度发布**: 逐步切换到容器化
2. **监控完善**: 全方位性能监控
3. **回滚方案**: 保留原部署方式

## 📈 预期收益

### 短期收益
- 开发环境标准化
- 服务独立扩展能力
- 部署一致性提升

### 长期收益
- 支持Kubernetes编排
- 微服务架构完善
- DevOps流程标准化

## 📝 相关文档

- [Docker最佳实践](../operations/docker-best-practices.md)
- [微服务架构指南](../architecture/microservices.md)
- [容器化部署指南](../../../deployment/docker/README.md)

---

**更新时间**: 2024-01-15  
**文档版本**: v1.0  
**负责人**: RedFire架构团队
