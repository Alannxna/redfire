# ğŸ³ TODO-03: å¾®æœåŠ¡å®¹å™¨åŒ–éƒ¨ç½²

## ğŸ¯ ä»»åŠ¡æ¦‚è¿°

**ä»»åŠ¡ID**: micro_01  
**ä¼˜å…ˆçº§**: é«˜  
**é¢„ä¼°å·¥æœŸ**: 4-5å¤©  
**è´Ÿè´£æ¨¡å—**: å¾®æœåŠ¡æ¶æ„

### é—®é¢˜æè¿°
å½“å‰RedFireé¡¹ç›®éœ€è¦ä¸º5ä¸ªå¾®æœåŠ¡åˆ›å»ºå®Œæ•´çš„Dockeré…ç½®å’Œdocker-composeç¼–æ’ï¼Œå®ç°æ ‡å‡†åŒ–çš„å®¹å™¨åŒ–éƒ¨ç½²ã€‚

## ğŸ” ç°çŠ¶åˆ†æ

### ç°æœ‰Dockeré…ç½®

#### 1. åç«¯Dockerfileåˆ†æ
```dockerfile
# backend/Dockerfile - ç°æœ‰é…ç½®
FROM python:3.11-slim as base

# å¤šé˜¶æ®µæ„å»ºé…ç½®
FROM base as development
FROM base as production  
FROM python:3.11-alpine as lightweight

# é—®é¢˜:
# - ç¼ºä¹å¾®æœåŠ¡ç‰¹å®šé…ç½®
# - ä¾èµ–å®‰è£…æ•ˆç‡ä½
# - é•œåƒä½“ç§¯è¾ƒå¤§
```

#### 2. Docker Composeç°çŠ¶
```yaml
# deployment/docker/docker-compose.yml - ç°æœ‰é…ç½®
services:
  postgres:
    image: postgres:15-alpine
  redis:
    image: redis:7-alpine
  backend:
    build: ../../backend
    ports: ["8000:8000"]
  frontend:
    build: ../../frontend/web-app

# é—®é¢˜:
# - æ²¡æœ‰å¾®æœåŠ¡æ‹†åˆ†
# - ç¼ºä¹æœåŠ¡å‘ç°é…ç½®
# - ç½‘ç»œéš”ç¦»ä¸å®Œå–„
```

### å¾®æœåŠ¡ç«¯å£é…ç½®

æ ¹æ®ä»£ç åˆ†æï¼Œç³»ç»Ÿå®šä¹‰äº†5ä¸ªå¾®æœåŠ¡ï¼š

```python
# config/backend/service_config.py
vnpy_core_port: int = 8006      # VnPyæ ¸å¿ƒæœåŠ¡
user_trading_port: int = 8001   # ç”¨æˆ·äº¤æ˜“æœåŠ¡  
strategy_data_port: int = 8002  # ç­–ç•¥æ•°æ®æœåŠ¡
gateway_port: int = 8004        # ç½‘å…³é€‚é…æœåŠ¡
monitor_port: int = 8005        # ç›‘æ§é€šçŸ¥æœåŠ¡
```

### ä»£ç è´¨é‡é—®é¢˜

#### 1. æ„å»ºæ•ˆç‡ä½
- Pythonä¾èµ–é‡å¤å®‰è£…
- ç¼ºä¹åˆ†å±‚ç¼“å­˜ä¼˜åŒ–
- é•œåƒæ„å»ºæ—¶é—´é•¿

#### 2. é…ç½®ç®¡ç†æ··ä¹±
- ç¯å¢ƒå˜é‡é…ç½®åˆ†æ•£
- æœåŠ¡é—´ä¾èµ–ä¸æ˜ç¡®
- å¥åº·æ£€æŸ¥ä¸å®Œå–„

#### 3. å®‰å…¨é—®é¢˜
- å®¹å™¨ä»¥rootç”¨æˆ·è¿è¡Œ
- æš´éœ²ä¸å¿…è¦ç«¯å£
- ç¼ºä¹å®‰å…¨æ‰«æ

## ğŸ¨ è®¾è®¡æ–¹æ¡ˆ

### 1. å¾®æœåŠ¡Dockerfileæ ‡å‡†åŒ–

```dockerfile
# deployment/docker/services/base/Dockerfile
FROM python:3.11-slim as base

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONPATH=/app \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    build-essential \
    libpq-dev \
    curl \
    && rm -rf /var/lib/apt/lists/*

# åˆ›å»ºérootç”¨æˆ·
RUN useradd --create-home --shell /bin/bash redfire
WORKDIR /app
RUN chown redfire:redfire /app
USER redfire

# å®‰è£…Pythonä¾èµ–
COPY requirements.txt .
RUN pip install --user -r requirements.txt

# ===============================
# VnPyæ ¸å¿ƒæœåŠ¡
# ===============================
FROM base as vnpy-core-service

LABEL maintainer="RedFire Team" \
      service="vnpy-core" \
      version="1.0.0"

# å¤åˆ¶æœåŠ¡ç‰¹å®šä»£ç 
COPY --chown=redfire:redfire ./services/vnpy-core/ ./
COPY --chown=redfire:redfire ./shared/ ./shared/

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:8006/health || exit 1

EXPOSE 8006

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8006"]

# ===============================  
# ç”¨æˆ·äº¤æ˜“æœåŠ¡
# ===============================
FROM base as user-trading-service

LABEL maintainer="RedFire Team" \
      service="user-trading" \
      version="1.0.0"

COPY --chown=redfire:redfire ./services/user-trading/ ./
COPY --chown=redfire:redfire ./shared/ ./shared/

HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:8001/health || exit 1

EXPOSE 8001

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8001"]
```

### 2. æœåŠ¡ç‰¹å®šDockerfile

```dockerfile
# deployment/docker/services/strategy-data/Dockerfile
FROM redfire/base:latest

LABEL service="strategy-data"

# å®‰è£…ç­–ç•¥æ•°æ®æœåŠ¡ç‰¹å®šä¾èµ–
COPY requirements-strategy.txt .
RUN pip install --user -r requirements-strategy.txt

# å¤åˆ¶æœåŠ¡ä»£ç 
COPY --chown=redfire:redfire ./services/strategy-data/ ./

# åˆ›å»ºæ•°æ®ç›®å½•
RUN mkdir -p data/strategies data/backtest data/reports

HEALTHCHECK --interval=60s --timeout=15s --start-period=45s --retries=2 \
    CMD curl -f http://localhost:8002/health || exit 1

EXPOSE 8002

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8002"]

# deployment/docker/services/gateway/Dockerfile  
FROM redfire/base:latest

LABEL service="gateway-adapter"

# ç½‘å…³æœåŠ¡ç‰¹å®šé…ç½®
COPY --chown=redfire:redfire ./services/gateway/ ./
COPY --chown=redfire:redfire ./adapters/ ./adapters/

# å®‰è£…äº¤æ˜“æ¥å£ä¾èµ–
RUN pip install --user vnpy[ctp] vnpy[ib] vnpy[okex]

HEALTHCHECK --interval=45s --timeout=20s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8004/health || exit 1

EXPOSE 8004

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8004"]
```

### 3. å®Œæ•´Docker Composeç¼–æ’

```yaml
# deployment/docker/docker-compose.yml
version: '3.8'

# ====================== ç½‘ç»œé…ç½® ======================
networks:
  redfire-frontend:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
  redfire-backend:
    driver: bridge  
    internal: true
    ipam:
      config:
        - subnet: 172.21.0.0/24
  redfire-data:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.22.0.0/24

# ====================== å·é…ç½® ======================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  influxdb_data:
    driver: local
  mongo_data:
    driver: local
  vnpy_data:
    driver: local
  logs_data:
    driver: local

# ====================== æœåŠ¡é…ç½® ======================
services:
  
  # ----- æ•°æ®åº“å±‚ -----
  postgres:
    image: postgres:15-alpine
    container_name: redfire-postgres
    environment:
      POSTGRES_DB: redfire
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d:ro
    networks:
      - redfire-data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d redfire"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  redis:
    image: redis:7-alpine
    container_name: redfire-redis
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    networks:
      - redfire-data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  influxdb:
    image: influxdb:2.7-alpine
    container_name: redfire-influxdb
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: ${INFLUX_USER}
      DOCKER_INFLUXDB_INIT_PASSWORD: ${INFLUX_PASSWORD}
      DOCKER_INFLUXDB_INIT_ORG: redfire
      DOCKER_INFLUXDB_INIT_BUCKET: market_data
    volumes:
      - influxdb_data:/var/lib/influxdb2
    networks:
      - redfire-data
    restart: unless-stopped

  mongodb:
    image: mongo:7.0
    container_name: redfire-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
      MONGO_INITDB_DATABASE: redfire_logs
    volumes:
      - mongo_data:/data/db
    networks:
      - redfire-data
    restart: unless-stopped

  # ----- VnPyæ ¸å¿ƒæœåŠ¡ -----
  vnpy-core:
    build:
      context: ../../backend
      dockerfile: deployment/docker/services/vnpy-core/Dockerfile
      target: vnpy-core-service
    container_name: redfire-vnpy-core
    environment:
      - SERVICE_NAME=vnpy_core
      - SERVICE_PORT=8006
      - DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@postgres:5432/redfire
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - ENVIRONMENT=${ENVIRONMENT:-production}
    volumes:
      - vnpy_data:/app/data
      - logs_data:/app/logs
    networks:
      - redfire-backend
      - redfire-data
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M

  # ----- ç”¨æˆ·äº¤æ˜“æœåŠ¡ -----  
  user-trading:
    build:
      context: ../../backend
      dockerfile: deployment/docker/services/user-trading/Dockerfile
      target: user-trading-service
    container_name: redfire-user-trading
    environment:
      - SERVICE_NAME=user_trading
      - SERVICE_PORT=8001
      - DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@postgres:5432/redfire
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/1
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
    networks:
      - redfire-backend
      - redfire-data
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      vnpy-core:
        condition: service_healthy
    restart: unless-stopped

  # ----- ç­–ç•¥æ•°æ®æœåŠ¡ -----
  strategy-data:
    build:
      context: ../../backend  
      dockerfile: deployment/docker/services/strategy-data/Dockerfile
    container_name: redfire-strategy-data
    environment:
      - SERVICE_NAME=strategy_data
      - SERVICE_PORT=8002
      - DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@postgres:5432/redfire
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUX_TOKEN}
    networks:
      - redfire-backend
      - redfire-data
    depends_on:
      postgres:
        condition: service_healthy
      influxdb:
        condition: service_started
    restart: unless-stopped

  # ----- ç½‘å…³é€‚é…æœåŠ¡ -----
  gateway-adapter:
    build:
      context: ../../backend
      dockerfile: deployment/docker/services/gateway/Dockerfile
    container_name: redfire-gateway
    environment:
      - SERVICE_NAME=gateway
      - SERVICE_PORT=8004
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/2
    volumes:
      - vnpy_data:/app/data:ro
    networks:
      - redfire-backend
      - redfire-data
    depends_on:
      redis:
        condition: service_healthy
      vnpy-core:
        condition: service_healthy
    restart: unless-stopped

  # ----- ç›‘æ§é€šçŸ¥æœåŠ¡ -----
  monitor-service:
    build:
      context: ../../backend
      dockerfile: deployment/docker/services/monitor/Dockerfile
    container_name: redfire-monitor
    environment:
      - SERVICE_NAME=monitor
      - SERVICE_PORT=8005
      - MONGO_URL=mongodb://${MONGO_USER}:${MONGO_PASSWORD}@mongodb:27017/redfire_logs
      - ALERT_WEBHOOK_URL=${ALERT_WEBHOOK_URL}
    volumes:
      - logs_data:/app/logs:ro
    networks:
      - redfire-backend
      - redfire-data
    depends_on:
      mongodb:
        condition: service_started
    restart: unless-stopped

  # ----- APIç½‘å…³ -----
  api-gateway:
    image: nginx:alpine
    container_name: redfire-api-gateway
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    networks:
      - redfire-frontend
      - redfire-backend
    depends_on:
      - user-trading
      - vnpy-core
      - strategy-data
      - gateway-adapter
      - monitor-service
    restart: unless-stopped
```

### 4. ç¯å¢ƒé…ç½®æ–‡ä»¶

```bash
# deployment/docker/.env.production
# æ•°æ®åº“é…ç½®
DB_USER=redfire_prod
DB_PASSWORD=secure_db_password_2024
DB_NAME=redfire

# Redisé…ç½®  
REDIS_PASSWORD=secure_redis_password_2024

# InfluxDBé…ç½®
INFLUX_USER=redfire_influx
INFLUX_PASSWORD=secure_influx_password_2024
INFLUX_TOKEN=influx_api_token_2024

# MongoDBé…ç½®
MONGO_USER=redfire_mongo
MONGO_PASSWORD=secure_mongo_password_2024

# åº”ç”¨é…ç½®
JWT_SECRET_KEY=super_secure_jwt_key_2024_32_chars_long
ENVIRONMENT=production
ALERT_WEBHOOK_URL=https://hooks.slack.com/services/...

# æœåŠ¡å‘ç°
SERVICE_REGISTRY_URL=http://consul:8500
```

## ğŸ”§ å®æ–½æ­¥éª¤

### é˜¶æ®µ1: åŸºç¡€é•œåƒæ„å»º (1å¤©)

1. **åˆ›å»ºæœåŠ¡ç›®å½•ç»“æ„**
   ```bash
   mkdir -p deployment/docker/services/{vnpy-core,user-trading,strategy-data,gateway,monitor}
   mkdir -p backend/services/{vnpy-core,user-trading,strategy-data,gateway,monitor}
   ```

2. **æ„å»ºåŸºç¡€é•œåƒ**
   ```bash
   cd deployment/docker
   docker build -f Dockerfile.base -t redfire/base:latest .
   ```

### é˜¶æ®µ2: å¾®æœåŠ¡æ‹†åˆ† (2å¤©)

1. **é‡æ„ç°æœ‰ä»£ç ä¸ºå¾®æœåŠ¡**
   - å°†monolithä»£ç æ‹†åˆ†åˆ°å„æœåŠ¡ç›®å½•
   - å®ç°æœåŠ¡é—´é€šä¿¡æ¥å£
   - é…ç½®æœåŠ¡ç‰¹å®šä¾èµ–

2. **æœåŠ¡å¥åº·æ£€æŸ¥ç«¯ç‚¹**
   ```python
   # æ¯ä¸ªæœåŠ¡æ·»åŠ å¥åº·æ£€æŸ¥
   @app.get("/health")
   async def health_check():
       return {
           "status": "healthy",
           "service": os.getenv("SERVICE_NAME"),
           "timestamp": datetime.utcnow().isoformat()
       }
   ```

### é˜¶æ®µ3: ç¼–æ’é…ç½® (1å¤©)

1. **Docker Composeé…ç½®**
   - ç½‘ç»œéš”ç¦»é…ç½®
   - å·æŒ‚è½½ä¼˜åŒ–
   - èµ„æºé™åˆ¶è®¾ç½®

2. **Nginxåå‘ä»£ç†**
   ```nginx
   # deployment/docker/nginx/nginx.conf
   upstream vnpy_core {
       server vnpy-core:8006;
   }
   
   upstream user_trading {
       server user-trading:8001;
   }
   
   server {
       listen 80;
       
       location /api/v1/auth/ {
           proxy_pass http://user_trading;
       }
       
       location /api/v1/trading/ {
           proxy_pass http://vnpy_core;
       }
   }
   ```

### é˜¶æ®µ4: ç”Ÿäº§ä¼˜åŒ– (1å¤©)

1. **é•œåƒä¼˜åŒ–**
   - å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–
   - ä¾èµ–å±‚ç¼“å­˜
   - é•œåƒä½“ç§¯å‹ç¼©

2. **å®‰å…¨åŠ å›º**
   ```dockerfile
   # å®‰å…¨æ‰«æ
   RUN apk add --no-cache dumb-init
   ENTRYPOINT ["dumb-init", "--"]
   
   # érootç”¨æˆ·
   USER redfire
   
   # åªæš´éœ²å¿…è¦ç«¯å£
   EXPOSE 8001
   ```

## ğŸ“Š éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] 5ä¸ªå¾®æœåŠ¡ç‹¬ç«‹å¯åŠ¨æˆåŠŸ
- [ ] æœåŠ¡é—´é€šä¿¡æ­£å¸¸
- [ ] æ•°æ®åº“è¿æ¥æ± å·¥ä½œæ­£å¸¸
- [ ] APIç½‘å…³è·¯ç”±æ­£ç¡®

### æ€§èƒ½æŒ‡æ ‡  
- [ ] å®¹å™¨å¯åŠ¨æ—¶é—´ < 30ç§’
- [ ] é•œåƒå¤§å° < 500MB
- [ ] å†…å­˜ä½¿ç”¨ä¼˜åŒ–
- [ ] CPUä½¿ç”¨æ•ˆç‡

### å®‰å…¨æ ‡å‡†
- [ ] å®¹å™¨érootç”¨æˆ·è¿è¡Œ
- [ ] ç½‘ç»œéš”ç¦»æ­£ç¡®é…ç½®
- [ ] æ•æ„Ÿä¿¡æ¯ç¯å¢ƒå˜é‡åŒ–
- [ ] å¥åº·æ£€æŸ¥å®Œå–„

## ğŸš¨ é£é™©è¯„ä¼°

### é«˜é£é™©
- **æœåŠ¡æ‹†åˆ†**: å¯èƒ½ç ´åç°æœ‰åŠŸèƒ½
- **æ•°æ®ä¸€è‡´æ€§**: å¾®æœåŠ¡é—´æ•°æ®åŒæ­¥é—®é¢˜

### ä¸­é£é™©
- **æ€§èƒ½å½±å“**: ç½‘ç»œé€šä¿¡å¼€é”€
- **è¿ç»´å¤æ‚åº¦**: å®¹å™¨ç®¡ç†å¤æ‚åŒ–

### ç¼“è§£æªæ–½
1. **ç°åº¦å‘å¸ƒ**: é€æ­¥åˆ‡æ¢åˆ°å®¹å™¨åŒ–
2. **ç›‘æ§å®Œå–„**: å…¨æ–¹ä½æ€§èƒ½ç›‘æ§
3. **å›æ»šæ–¹æ¡ˆ**: ä¿ç•™åŸéƒ¨ç½²æ–¹å¼

## ğŸ“ˆ é¢„æœŸæ”¶ç›Š

### çŸ­æœŸæ”¶ç›Š
- å¼€å‘ç¯å¢ƒæ ‡å‡†åŒ–
- æœåŠ¡ç‹¬ç«‹æ‰©å±•èƒ½åŠ›
- éƒ¨ç½²ä¸€è‡´æ€§æå‡

### é•¿æœŸæ”¶ç›Š
- æ”¯æŒKubernetesç¼–æ’
- å¾®æœåŠ¡æ¶æ„å®Œå–„
- DevOpsæµç¨‹æ ‡å‡†åŒ–

## ğŸ“ ç›¸å…³æ–‡æ¡£

- [Dockeræœ€ä½³å®è·µ](../operations/docker-best-practices.md)
- [å¾®æœåŠ¡æ¶æ„æŒ‡å—](../architecture/microservices.md)
- [å®¹å™¨åŒ–éƒ¨ç½²æŒ‡å—](../../../deployment/docker/README.md)

---

**æ›´æ–°æ—¶é—´**: 2024-01-15  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**è´Ÿè´£äºº**: RedFireæ¶æ„å›¢é˜Ÿ
