# âš™ï¸ TODO-02: é…ç½®ç®¡ç†ç³»ç»Ÿé‡æ„

## ğŸ¯ ä»»åŠ¡æ¦‚è¿°

**ä»»åŠ¡ID**: arch_02  
**ä¼˜å…ˆçº§**: é«˜  
**é¢„ä¼°å·¥æœŸ**: 3-4å¤©  
**è´Ÿè´£æ¨¡å—**: ç³»ç»Ÿæ¶æ„ä¼˜åŒ–

### é—®é¢˜æè¿°
å½“å‰RedFireé¡¹ç›®çš„é…ç½®ç®¡ç†å­˜åœ¨ä¸¥é‡çš„åˆ†æ•£åŒ–å’Œé‡å¤é—®é¢˜ï¼Œéœ€è¦å»ºç«‹ç»Ÿä¸€çš„é…ç½®ç®¡ç†ä½“ç³»ã€‚

## ğŸ” ç°çŠ¶åˆ†æ

### é…ç½®æ–‡ä»¶åˆ†æ•£é—®é¢˜

#### 1. å¤šä¸ªé…ç½®ç±»å¹¶å­˜
```python
# config/backend/app_config.py
class AppConfig(BaseSettings):
    app_name: str = "VnPy Web"
    host: str = "0.0.0.0"
    port: int = 8000
    
# backend/legacy/core/config/unified_config.py  
class UnifiedConfig(BaseConfig):
    app_name: str = Field(default="VnPy Web")
    host: str = Field(default="0.0.0.0")
    port: int = Field(default=8000)
    
# backend/core/vnpy-engine/config/backend/app_config.py
class AppConfig(BaseSettings):  # é‡å¤å®šä¹‰
    # ç›¸åŒå­—æ®µé‡å¤å®šä¹‰
```

#### 2. ç¯å¢ƒæ–‡ä»¶é‡å¤
```
config/backend/config.env
config/config.env  
backend/legacy/database_config.py
backend/core/vnpy-engine/config/config.env
backend/core/vnpy-engine/config/backend/config.env
```

#### 3. æ•°æ®åº“é…ç½®æ··ä¹±
```python
# backend/legacy/database_config.py
DATABASE_TYPE = "mysql"
MYSQL_HOST = "localhost"

# config/backend/database_config.py 
class DatabaseConfig:
    db_type: str = "mysql"
    host: str = "localhost"
    
# backend/core/vnpy-engine/config/backend/database_config.py
class DatabaseConfig(BaseModel):  # ç¬¬ä¸‰ä¸ªç‰ˆæœ¬
```

### ä»£ç è´¨é‡é—®é¢˜

#### 1. é…ç½®åŠ è½½é€»è¾‘é‡å¤
```python
# åœ¨å¤šä¸ªæ–‡ä»¶ä¸­é‡å¤çš„é…ç½®åŠ è½½ä»£ç 
class ConfigManager:
    def __init__(self):
        self._load_default_sources()  # é‡å¤å®ç°
        
    def _load_default_sources(self):
        # ç›¸ä¼¼çš„åŠ è½½é€»è¾‘åœ¨å¤šå¤„é‡å¤
        config_dir = self.base_path / "config"
        self.add_config_source("file", str(config_dir / "default.yaml"))
```

#### 2. ç¯å¢ƒå˜é‡ç®¡ç†ä¸ç»Ÿä¸€
```python
# ç¡¬ç¼–ç çš„ç¯å¢ƒå˜é‡è·å–
DB_HOST = os.getenv('DB_HOST', 'localhost')
DB_PORT = int(os.getenv('DB_PORT', 3306))

# Pydantic Settingsæ··åˆä½¿ç”¨
class Settings(BaseSettings):
    db_host: str = Field(default="localhost", env="DB_HOST")
```

#### 3. é…ç½®éªŒè¯ä¸å®Œæ•´
- ç¼ºä¹é…ç½®å€¼çš„æœ‰æ•ˆæ€§éªŒè¯
- å¿…éœ€é…ç½®é¡¹æ£€æŸ¥ä¸å®Œå–„
- é…ç½®æ ¼å¼é”™è¯¯å¤„ç†ä¸å½“

### æ¶æ„é—®é¢˜

#### 1. é…ç½®ä¼˜å…ˆçº§ä¸æ˜ç¡®
```
ç¯å¢ƒå˜é‡ vs é…ç½®æ–‡ä»¶ vs é»˜è®¤å€¼
|
â”œâ”€â”€ ä¸åŒæ¨¡å—æœ‰ä¸åŒçš„ä¼˜å…ˆçº§è§„åˆ™
â”œâ”€â”€ è¦†ç›–å…³ç³»ä¸æ¸…æ™°
â””â”€â”€ è°ƒè¯•å›°éš¾
```

#### 2. é…ç½®å˜æ›´æ²¡æœ‰ç‰ˆæœ¬æ§åˆ¶
- ç”Ÿäº§ç¯å¢ƒé…ç½®å˜æ›´æ— è¿½è¸ª
- é…ç½®å›æ»šæœºåˆ¶ç¼ºå¤±
- é…ç½®å˜æ›´å½±å“èŒƒå›´ä¸æ˜

#### 3. å¾®æœåŠ¡é…ç½®éš”ç¦»ä¸è¶³
- ä¸åŒæœåŠ¡çš„é…ç½®æ··åˆåœ¨ä¸€èµ·
- ç¼ºä¹æœåŠ¡ç‰¹å®šçš„é…ç½®å‘½åç©ºé—´
- é…ç½®ä¾èµ–å…³ç³»å¤æ‚

## ğŸ¨ è®¾è®¡æ–¹æ¡ˆ

### 1. ç»Ÿä¸€é…ç½®æ¶æ„

```python
# config/core/base_config.py
class BaseConfig(BaseSettings):
    """åŸºç¡€é…ç½®ç±»"""
    
    model_config = SettingsConfigDict(
        env_file=".env",
        env_file_encoding="utf-8",
        case_sensitive=False,
        extra="forbid"  # ç¦æ­¢é¢å¤–å­—æ®µ
    )
    
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self._validate_config()
        
    def _validate_config(self):
        """é…ç½®éªŒè¯"""
        if self.port < 1 or self.port > 65535:
            raise ValueError(f"æ— æ•ˆç«¯å£å·: {self.port}")

# config/core/app_config.py  
class AppConfig(BaseConfig):
    """åº”ç”¨æ ¸å¿ƒé…ç½®"""
    
    # åº”ç”¨åŸºç¡€ä¿¡æ¯
    app_name: str = Field(default="RedFire", description="åº”ç”¨åç§°")
    app_version: str = Field(default="2.0.0", description="åº”ç”¨ç‰ˆæœ¬") 
    debug: bool = Field(default=False, description="è°ƒè¯•æ¨¡å¼")
    
    # æœåŠ¡å™¨é…ç½®
    host: str = Field(default="0.0.0.0", description="æœåŠ¡å™¨ä¸»æœº")
    port: int = Field(default=8000, ge=1, le=65535, description="æœåŠ¡å™¨ç«¯å£")
    workers: int = Field(default=1, ge=1, description="å·¥ä½œè¿›ç¨‹æ•°")
    
    # ç¯å¢ƒé…ç½®
    environment: str = Field(default="development", description="è¿è¡Œç¯å¢ƒ")
    
    @field_validator('environment')
    def validate_environment(cls, v):
        allowed = ['development', 'testing', 'staging', 'production']
        if v not in allowed:
            raise ValueError(f'ç¯å¢ƒå¿…é¡»æ˜¯ {allowed} ä¹‹ä¸€')
        return v
```

### 2. åˆ†å±‚é…ç½®ä½“ç³»

```python
# config/core/config_hierarchy.py
class ConfigHierarchy:
    """é…ç½®å±‚æ¬¡ç»“æ„ç®¡ç†"""
    
    def __init__(self):
        self.layers = [
            ConfigLayer("defaults", priority=1),      # é»˜è®¤å€¼
            ConfigLayer("file", priority=2),          # é…ç½®æ–‡ä»¶  
            ConfigLayer("environment", priority=3),   # ç¯å¢ƒå˜é‡
            ConfigLayer("runtime", priority=4),       # è¿è¡Œæ—¶é…ç½®
            ConfigLayer("override", priority=5)       # å¼ºåˆ¶è¦†ç›–
        ]
    
    def resolve_config(self, key: str) -> Any:
        """è§£æé…ç½®å€¼ï¼ŒæŒ‰ä¼˜å…ˆçº§é¡ºåº"""
        for layer in sorted(self.layers, key=lambda x: x.priority, reverse=True):
            if layer.has_key(key):
                return layer.get_value(key)
        raise KeyError(f"é…ç½®é¡¹ {key} æœªæ‰¾åˆ°")

# config/core/service_configs.py
class ServiceConfig(BaseConfig):
    """å¾®æœåŠ¡é…ç½®åŸºç±»"""
    
    service_name: str = Field(..., description="æœåŠ¡åç§°")
    service_port: int = Field(..., description="æœåŠ¡ç«¯å£")
    service_host: str = Field(default="0.0.0.0", description="æœåŠ¡ä¸»æœº")
    
class VnPyCoreConfig(ServiceConfig):
    """VnPyæ ¸å¿ƒæœåŠ¡é…ç½®"""
    
    service_name: str = Field(default="vnpy_core")
    service_port: int = Field(default=8006)
    
    # VnPyç‰¹å®šé…ç½®
    vnpy_data_dir: str = Field(default="./vnpy_data")
    vnpy_config_dir: str = Field(default="./vnpy_config")
    
class UserTradingConfig(ServiceConfig):
    """ç”¨æˆ·äº¤æ˜“æœåŠ¡é…ç½®"""
    
    service_name: str = Field(default="user_trading")
    service_port: int = Field(default=8001)
    
    # JWTé…ç½®
    jwt_secret_key: str = Field(..., description="JWTå¯†é’¥")
    jwt_algorithm: str = Field(default="HS256")
```

### 3. é…ç½®ç®¡ç†å™¨

```python
# config/core/config_manager.py
class ConfigManager:
    """ç»Ÿä¸€é…ç½®ç®¡ç†å™¨"""
    
    def __init__(self):
        self._configs: Dict[str, BaseConfig] = {}
        self._hierarchy = ConfigHierarchy()
        self._watchers: List[ConfigWatcher] = []
        
    def register_config(self, name: str, config_class: Type[BaseConfig]):
        """æ³¨å†Œé…ç½®ç±»"""
        try:
            config = config_class()
            self._configs[name] = config
            self.logger.info(f"å·²æ³¨å†Œé…ç½®: {name}")
        except Exception as e:
            self.logger.error(f"é…ç½®æ³¨å†Œå¤±è´¥ {name}: {e}")
            raise
    
    def get_config(self, name: str) -> BaseConfig:
        """è·å–é…ç½®å®ä¾‹"""
        if name not in self._configs:
            raise ValueError(f"æœªæ³¨å†Œçš„é…ç½®: {name}")
        return self._configs[name]
    
    def reload_config(self, name: str):
        """é‡æ–°åŠ è½½é…ç½®"""
        if name in self._configs:
            config_class = type(self._configs[name])
            new_config = config_class()
            old_config = self._configs[name]
            self._configs[name] = new_config
            
            # é€šçŸ¥é…ç½®å˜æ›´
            self._notify_watchers(name, old_config, new_config)
    
    def watch_config(self, name: str, callback: Callable):
        """ç›‘å¬é…ç½®å˜æ›´"""
        watcher = ConfigWatcher(name, callback)
        self._watchers.append(watcher)
```

### 4. ç¯å¢ƒç‰¹å®šé…ç½®

```python
# config/environments/base.py
class EnvironmentConfig(BaseConfig):
    """ç¯å¢ƒç‰¹å®šé…ç½®åŸºç±»"""
    
    database_url: str = Field(..., description="æ•°æ®åº“è¿æ¥URL")
    redis_url: str = Field(..., description="Redisè¿æ¥URL")
    log_level: str = Field(default="INFO", description="æ—¥å¿—çº§åˆ«")

# config/environments/development.py
class DevelopmentConfig(EnvironmentConfig):
    """å¼€å‘ç¯å¢ƒé…ç½®"""
    
    debug: bool = Field(default=True)
    database_url: str = Field(default="mysql://root:root@localhost:3306/redfire_dev")
    redis_url: str = Field(default="redis://localhost:6379/0")
    log_level: str = Field(default="DEBUG")
    
    # å¼€å‘ç‰¹å®šè®¾ç½®
    hot_reload: bool = Field(default=True)
    api_docs_enabled: bool = Field(default=True)

# config/environments/production.py  
class ProductionConfig(EnvironmentConfig):
    """ç”Ÿäº§ç¯å¢ƒé…ç½®"""
    
    debug: bool = Field(default=False)
    
    # ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä»ç¯å¢ƒå˜é‡è·å–
    database_url: str = Field(..., env="DATABASE_URL")
    redis_url: str = Field(..., env="REDIS_URL")
    
    # å®‰å…¨è®¾ç½®
    secret_key: str = Field(..., env="SECRET_KEY", min_length=32)
    allowed_hosts: List[str] = Field(..., env="ALLOWED_HOSTS")
    
    # æ€§èƒ½è®¾ç½®
    workers: int = Field(default=4, env="WORKERS")
    max_connections: int = Field(default=100, env="MAX_CONNECTIONS")
```

## ğŸ”§ å®æ–½æ­¥éª¤

### é˜¶æ®µ1: é…ç½®ç±»ç»Ÿä¸€ (2å¤©)

1. **åˆ›å»ºåŸºç¡€é…ç½®æ¶æ„**
   ```bash
   mkdir -p config/core
   mkdir -p config/environments
   mkdir -p config/services
   ```

2. **å®ç°BaseConfigåŸºç±»**
   - ç»Ÿä¸€å­—æ®µéªŒè¯è§„åˆ™
   - æ ‡å‡†åŒ–é”™è¯¯å¤„ç†
   - é›†æˆæ—¥å¿—è®°å½•

3. **è¿ç§»ç°æœ‰é…ç½®**
   ```python
   # é€æ­¥è¿ç§»ç°æœ‰é…ç½®åˆ°æ–°æ¶æ„
   from config.legacy.app_config import AppConfig as LegacyAppConfig
   from config.core.app_config import AppConfig
   
   def migrate_config():
       legacy = LegacyAppConfig()
       new_config = AppConfig(
           app_name=legacy.app_name,
           port=legacy.port
       )
       return new_config
   ```

### é˜¶æ®µ2: é…ç½®ç®¡ç†å™¨å®ç° (1å¤©)

1. **ConfigManageræ ¸å¿ƒé€»è¾‘**
   - é…ç½®æ³¨å†Œå’Œè·å–
   - é…ç½®å˜æ›´ç›‘å¬
   - é…ç½®éªŒè¯å’Œé”™è¯¯å¤„ç†

2. **é…ç½®åŠ è½½ç­–ç•¥**
   ```python
   # é…ç½®åŠ è½½ä¼˜å…ˆçº§
   manager = ConfigManager()
   manager.set_loading_strategy([
       FileConfigLoader("config/default.yaml"),
       EnvironmentConfigLoader(),
       RuntimeConfigLoader()
   ])
   ```

### é˜¶æ®µ3: ç¯å¢ƒé…ç½®åˆ†ç¦» (1å¤©)

1. **ç¯å¢ƒç‰¹å®šé…ç½®æ–‡ä»¶**
   ```
   config/
   â”œâ”€â”€ environments/
   â”‚   â”œâ”€â”€ development.yaml
   â”‚   â”œâ”€â”€ testing.yaml  
   â”‚   â”œâ”€â”€ staging.yaml
   â”‚   â””â”€â”€ production.yaml
   ```

2. **åŠ¨æ€ç¯å¢ƒæ£€æµ‹**
   ```python
   def detect_environment() -> str:
       return os.getenv('ENVIRONMENT', 'development')
   
   config = get_environment_config(detect_environment())
   ```

## ğŸ“Š éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] å•ä¸€é…ç½®ç®¡ç†å…¥å£
- [ ] é…ç½®ä¼˜å…ˆçº§æ­£ç¡®åº”ç”¨
- [ ] ç¯å¢ƒé…ç½®è‡ªåŠ¨åŠ è½½
- [ ] é…ç½®å˜æ›´çƒ­é‡è½½

### ä»£ç è´¨é‡
- [ ] åˆ é™¤æ‰€æœ‰é‡å¤é…ç½®ç±»
- [ ] é…ç½®éªŒè¯å®Œæ•´è¦†ç›–
- [ ] é”™è¯¯å¤„ç†æ ‡å‡†åŒ–
- [ ] æ–‡æ¡£æ³¨é‡Šå®Œå–„

### æ€§èƒ½æŒ‡æ ‡
- [ ] é…ç½®åŠ è½½æ—¶é—´ < 1ç§’
- [ ] å†…å­˜å ç”¨ä¼˜åŒ–
- [ ] é…ç½®è®¿é—®å»¶è¿Ÿæœ€å°åŒ–

## ğŸš¨ é£é™©è¯„ä¼°

### é«˜é£é™©
- **é…ç½®å…¼å®¹æ€§**: æ–°é…ç½®å¯èƒ½ä¸ç°æœ‰ä»£ç ä¸å…¼å®¹
- **ç¯å¢ƒå˜é‡å˜æ›´**: éœ€è¦æ›´æ–°éƒ¨ç½²é…ç½®

### ä¸­é£é™©
- **é…ç½®è¿ç§»**: æ•°æ®å¯èƒ½ä¸¢å¤±æˆ–æ ¼å¼é”™è¯¯
- **æ€§èƒ½å½±å“**: æ–°é…ç½®ç³»ç»Ÿå¯èƒ½å½±å“å¯åŠ¨æ€§èƒ½

### ç¼“è§£æªæ–½
1. **æ¸è¿›å¼è¿ç§»**: ä¿æŒå‘åå…¼å®¹
2. **é…ç½®å¤‡ä»½**: è¿ç§»å‰å¤‡ä»½æ‰€æœ‰é…ç½®
3. **å……åˆ†æµ‹è¯•**: åœ¨æ‰€æœ‰ç¯å¢ƒä¸­éªŒè¯

## ğŸ“ˆ é¢„æœŸæ”¶ç›Š

### çŸ­æœŸæ”¶ç›Š
- é…ç½®ç®¡ç†å¤æ‚åº¦å¤§å¹…é™ä½
- å¼€å‘ç¯å¢ƒè®¾ç½®æ ‡å‡†åŒ–
- é…ç½®é”™è¯¯ç‡æ˜¾è‘—å‡å°‘

### é•¿æœŸæ”¶ç›Š
- æ”¯æŒé…ç½®ä¸­å¿ƒé›†æˆ
- å¤šç¯å¢ƒéƒ¨ç½²ç®€åŒ–
- å¾®æœåŠ¡é…ç½®éš”ç¦»

## ğŸ“ ç›¸å…³æ–‡æ¡£

- [é…ç½®ç®¡ç†æœ€ä½³å®è·µ](../development/config-best-practices.md)
- [ç¯å¢ƒéƒ¨ç½²æŒ‡å—](../../../deployment/environments/README.md)
- [å¾®æœåŠ¡é…ç½®æŒ‡å—](../architecture/microservices-config.md)

---

**æ›´æ–°æ—¶é—´**: 2024-01-15  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**è´Ÿè´£äºº**: RedFireæ¶æ„å›¢é˜Ÿ
