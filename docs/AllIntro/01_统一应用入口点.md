# ğŸ“‹ TODO-01: ç»Ÿä¸€åº”ç”¨å…¥å£ç‚¹æ•´åˆ

## ğŸ¯ ä»»åŠ¡æ¦‚è¿°

**ä»»åŠ¡ID**: arch_01  
**ä¼˜å…ˆçº§**: é«˜  
**é¢„ä¼°å·¥æœŸ**: 2-3å¤©  
**è´Ÿè´£æ¨¡å—**: ç³»ç»Ÿæ¶æ„ä¼˜åŒ–

### é—®é¢˜æè¿°
å½“å‰RedFireåç«¯å­˜åœ¨å¤šä¸ªåº”ç”¨å…¥å£ç‚¹ï¼Œå¯¼è‡´å¯åŠ¨æµç¨‹æ··ä¹±å’Œç»´æŠ¤å›°éš¾ï¼š

1. **ä¸»è¦å…¥å£æ–‡ä»¶**:
   - `backend/main.py` - å½“å‰ä¸»åº”ç”¨å…¥å£
   - `backend/legacy/interfaces/rest/app.py` - REST APIåº”ç”¨ 
   - `backend/run_server.py` - æœåŠ¡å™¨å¯åŠ¨è„šæœ¬

2. **å¯åŠ¨è„šæœ¬**:
   - `backend/run_server.bat` - Windowsæ‰¹å¤„ç†å¯åŠ¨
   - å¤šä¸ªå¼€å‘ç¯å¢ƒå¯åŠ¨é…ç½®

## ğŸ” ç°çŠ¶åˆ†æ

### ä»£ç è´¨é‡é—®é¢˜

#### 1. å…¥å£æ–‡ä»¶åˆ†æ•£
```python
# backend/main.py - ç®€å•çš„FastAPIåº”ç”¨
app = FastAPI(
    title="RedFire API",
    description="RedFire åº”ç”¨åç«¯APIæœåŠ¡",
    version="1.0.0"
)

# backend/legacy/interfaces/rest/app.py - VnPy Web API
class VnPyWebAPI:
    def __init__(self):
        # å¤æ‚çš„åˆå§‹åŒ–é€»è¾‘
        
# backend/run_server.py - å¯åŠ¨è„šæœ¬
def main():
    subprocess.run([
        sys.executable, "-m", "uvicorn", 
        "main:app", "--host", "127.0.0.1"
    ])
```

#### 2. é…ç½®ä¸ç»Ÿä¸€
- `main.py` ä¸­ç¡¬ç¼–ç CORSé…ç½®
- ç¼ºä¹ç»Ÿä¸€çš„ç¯å¢ƒå˜é‡ç®¡ç†
- æ•°æ®åº“åˆå§‹åŒ–é€»è¾‘åˆ†æ•£

#### 3. ä¸­é—´ä»¶é‡å¤
- è®¤è¯ä¸­é—´ä»¶åœ¨å¤šå¤„å®šä¹‰
- CORSé…ç½®åœ¨ä¸åŒå…¥å£é‡å¤
- å¼‚å¸¸å¤„ç†é€»è¾‘ä¸ä¸€è‡´

### æ¶æ„é—®é¢˜

#### 1. ä¾èµ–å…³ç³»æ··ä¹±
```
main.py â†’ database.py
       â†’ api.auth_routes
       
app.py â†’ VnPyWebAPI â†’ [å¤æ‚ä¾èµ–é“¾]
      â†’ multiple middleware
      â†’ legacy components
```

#### 2. å¯åŠ¨é¡ºåºä¸æ˜ç¡®
- æ²¡æœ‰æ˜ç¡®çš„æœåŠ¡å¯åŠ¨é¡ºåº
- ç»„ä»¶åˆå§‹åŒ–ä¾èµ–å…³ç³»ä¸æ¸…
- é”™è¯¯å¤„ç†å’Œå›æ»šæœºåˆ¶ç¼ºå¤±

#### 3. ç¯å¢ƒé€‚é…æ€§å·®
- å¼€å‘/ç”Ÿäº§ç¯å¢ƒé…ç½®æ··åˆ
- Dockerå®¹å™¨å¯åŠ¨è·¯å¾„ä¸ç»Ÿä¸€
- å¾®æœåŠ¡æ‹†åˆ†å‡†å¤‡ä¸è¶³

## ğŸ¨ è®¾è®¡æ–¹æ¡ˆ

### 1. ç»Ÿä¸€å…¥å£æ¶æ„

```python
# backend/main.py - ç»Ÿä¸€ä¸»å…¥å£
class RedFireApplication:
    """RedFireåº”ç”¨ä¸»ç±»"""
    
    def __init__(self, config: Optional[UnifiedConfig] = None):
        self.config = config or self._load_config()
        self.app = None
        self._components = {}
        
    def create_app(self) -> FastAPI:
        """åˆ›å»ºFastAPIåº”ç”¨å®ä¾‹"""
        app = FastAPI(
            title=self.config.app_name,
            version=self.config.app_version,
            debug=self.config.debug
        )
        
        # æ³¨å†Œä¸­é—´ä»¶
        self._register_middleware(app)
        
        # æ³¨å†Œè·¯ç”±
        self._register_routes(app)
        
        # æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
        self._register_events(app)
        
        return app
    
    def _register_middleware(self, app: FastAPI):
        """æ³¨å†Œä¸­é—´ä»¶"""
        # CORSä¸­é—´ä»¶
        app.add_middleware(
            CORSMiddleware,
            **self.config.cors_settings
        )
        
        # è®¤è¯ä¸­é—´ä»¶
        app.add_middleware(AuthMiddleware)
        
        # æ—¥å¿—ä¸­é—´ä»¶
        app.add_middleware(LoggingMiddleware)
    
    def _register_routes(self, app: FastAPI):
        """æ³¨å†Œè·¯ç”±"""
        # æ ¸å¿ƒAPIè·¯ç”±
        app.include_router(auth_router, prefix="/api/v1")
        app.include_router(trading_router, prefix="/api/v1")
        
        # å¥åº·æ£€æŸ¥
        app.include_router(health_router)
        
        # é™æ€æ–‡ä»¶
        if self.config.serve_static:
            app.mount("/static", StaticFiles(directory="static"))
```

### 2. ç»„ä»¶åˆå§‹åŒ–å™¨

```python
# backend/core/initializer.py
class ComponentInitializer:
    """ç»„ä»¶åˆå§‹åŒ–å™¨"""
    
    def __init__(self, config: UnifiedConfig):
        self.config = config
        self.logger = logging.getLogger(__name__)
        
    async def initialize_database(self):
        """åˆå§‹åŒ–æ•°æ®åº“"""
        try:
            db_manager = DatabaseManager()
            await db_manager.initialize(self.config.database_url)
            self.logger.info("æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ")
        except Exception as e:
            self.logger.error(f"æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: {e}")
            raise
    
    async def initialize_redis(self):
        """åˆå§‹åŒ–Redis"""
        try:
            redis_manager = RedisManager()
            await redis_manager.initialize(self.config.redis_url)
            self.logger.info("Redisåˆå§‹åŒ–å®Œæˆ")
        except Exception as e:
            self.logger.error(f"Redisåˆå§‹åŒ–å¤±è´¥: {e}")
            raise
    
    async def initialize_vnpy_engine(self):
        """åˆå§‹åŒ–VnPyå¼•æ“"""
        try:
            vnpy_engine = VnPyEngine(self.config.vnpy_config)
            await vnpy_engine.start()
            self.logger.info("VnPyå¼•æ“å¯åŠ¨å®Œæˆ")
        except Exception as e:
            self.logger.error(f"VnPyå¼•æ“å¯åŠ¨å¤±è´¥: {e}")
            raise
```

### 3. å¯åŠ¨ç”Ÿå‘½å‘¨æœŸç®¡ç†

```python
# backend/core/lifecycle.py
class ApplicationLifecycle:
    """åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†"""
    
    def __init__(self, app: FastAPI, config: UnifiedConfig):
        self.app = app
        self.config = config
        self.initializer = ComponentInitializer(config)
        
    async def startup(self):
        """å¯åŠ¨äº‹ä»¶"""
        self.logger.info("å¼€å§‹å¯åŠ¨RedFireåº”ç”¨...")
        
        # 1. åˆå§‹åŒ–æ ¸å¿ƒç»„ä»¶
        await self.initializer.initialize_database()
        await self.initializer.initialize_redis()
        
        # 2. åˆå§‹åŒ–ä¸šåŠ¡ç»„ä»¶
        await self.initializer.initialize_vnpy_engine()
        
        # 3. å¯åŠ¨ç›‘æ§
        await self._start_monitoring()
        
        self.logger.info("RedFireåº”ç”¨å¯åŠ¨å®Œæˆ!")
    
    async def shutdown(self):
        """å…³é—­äº‹ä»¶"""
        self.logger.info("å¼€å§‹å…³é—­RedFireåº”ç”¨...")
        
        # ä¼˜é›…å…³é—­æ‰€æœ‰ç»„ä»¶
        await self._graceful_shutdown()
        
        self.logger.info("RedFireåº”ç”¨å·²å…³é—­")
```

## ğŸ”§ å®æ–½æ­¥éª¤

### é˜¶æ®µ1: ä»£ç æ•´åˆ (1å¤©)

1. **åˆ›å»ºç»Ÿä¸€å…¥å£ç±»**
   ```bash
   # åˆ›å»ºæ–°çš„åº”ç”¨ä¸»ç±»
   touch backend/core/app.py
   
   # ç§»åŠ¨ç°æœ‰è·¯ç”±åˆ°æ ‡å‡†ä½ç½®
   mkdir -p backend/api/v1/
   mv backend/api/auth_routes.py backend/api/v1/
   ```

2. **é‡æ„main.py**
   - ä½¿ç”¨æ–°çš„RedFireApplicationç±»
   - é›†æˆVnPyWebAPIåŠŸèƒ½
   - ç»Ÿä¸€é…ç½®ç®¡ç†

3. **æ¸…ç†é‡å¤æ–‡ä»¶**
   - åˆ é™¤`backend/legacy/interfaces/rest/app.py`
   - æ•´åˆ`run_server.py`åŠŸèƒ½åˆ°main.py
   - æ¸…ç†é‡å¤çš„å¯åŠ¨è„šæœ¬

### é˜¶æ®µ2: ä¸­é—´ä»¶ç»Ÿä¸€ (1å¤©)

1. **ä¸­é—´ä»¶é‡æ„**
   ```python
   # backend/middleware/__init__.py
   from .auth_middleware import AuthMiddleware
   from .cors_middleware import CORSMiddleware
   from .logging_middleware import LoggingMiddleware
   
   __all__ = ['AuthMiddleware', 'CORSMiddleware', 'LoggingMiddleware']
   ```

2. **è·¯ç”±è§„èŒƒåŒ–**
   - ç»Ÿä¸€è·¯ç”±å‰ç¼€ `/api/v1`
   - æ ‡å‡†åŒ–å“åº”æ ¼å¼
   - é›†æˆé”™è¯¯å¤„ç†

### é˜¶æ®µ3: é…ç½®ç»Ÿä¸€ (1å¤©)

1. **ç¯å¢ƒå˜é‡ç®¡ç†**
   ```python
   # ä½¿ç”¨ç»Ÿä¸€é…ç½®ç±»
   config = UnifiedConfig.from_env()
   app = RedFireApplication(config).create_app()
   ```

2. **Dockeré…ç½®æ›´æ–°**
   ```dockerfile
   # æ›´æ–°Dockerfileå¯åŠ¨å‘½ä»¤
   CMD ["python", "-m", "uvicorn", "main:app", "--host", "0.0.0.0"]
   ```

## ğŸ“Š éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] å•ä¸€ä¸»å…¥å£æ–‡ä»¶å¯åŠ¨æˆåŠŸ
- [ ] æ‰€æœ‰ç°æœ‰APIæ¥å£æ­£å¸¸å·¥ä½œ
- [ ] æ•°æ®åº“è¿æ¥å’Œåˆå§‹åŒ–æ­£å¸¸
- [ ] VnPyå¼•æ“é›†æˆæ— è¯¯

### ä»£ç è´¨é‡
- [ ] åˆ é™¤æ‰€æœ‰é‡å¤å…¥å£æ–‡ä»¶
- [ ] ä¸­é—´ä»¶æ³¨å†Œç»Ÿä¸€åŒ–
- [ ] é…ç½®ç®¡ç†æ ‡å‡†åŒ–
- [ ] é”™è¯¯å¤„ç†æœºåˆ¶å®Œå–„

### æ€§èƒ½æŒ‡æ ‡
- [ ] å¯åŠ¨æ—¶é—´ < 10ç§’
- [ ] å†…å­˜å ç”¨æ— æ˜¾è‘—å¢åŠ 
- [ ] APIå“åº”æ—¶é—´ä¿æŒä¸€è‡´

## ğŸš¨ é£é™©è¯„ä¼°

### é«˜é£é™©
- **ç°æœ‰åŠŸèƒ½ç ´å**: é‡æ„å¯èƒ½å½±å“ç°æœ‰API
- **VnPyé›†æˆé—®é¢˜**: å¯èƒ½å½±å“äº¤æ˜“åŠŸèƒ½

### ä¸­é£é™©  
- **é…ç½®è¿ç§»**: ç¯å¢ƒå˜é‡é…ç½®éœ€è¦æ›´æ–°
- **Dockeréƒ¨ç½²**: å®¹å™¨å¯åŠ¨å‘½ä»¤éœ€è¦è°ƒæ•´

### ç¼“è§£æªæ–½
1. **åˆ†æ­¥éª¤å®æ–½**: é€æ­¥è¿ç§»ï¼Œä¿æŒå‘åå…¼å®¹
2. **å……åˆ†æµ‹è¯•**: æ¯ä¸ªé˜¶æ®µå®Œæˆåè¿›è¡Œå…¨é¢æµ‹è¯•
3. **å›æ»šæ–¹æ¡ˆ**: ä¿ç•™åŸæœ‰æ–‡ä»¶ä½œä¸ºå¤‡ä»½

## ğŸ“ˆ é¢„æœŸæ”¶ç›Š

### çŸ­æœŸæ”¶ç›Š
- å¯åŠ¨æµç¨‹ç®€åŒ–ï¼Œå‡å°‘ç»´æŠ¤æˆæœ¬
- å¼€å‘ä½“éªŒæ”¹å–„ï¼Œæ–°äººä¸Šæ‰‹æ›´å®¹æ˜“
- éƒ¨ç½²é…ç½®ç»Ÿä¸€ï¼Œè¿ç»´æˆæœ¬é™ä½

### é•¿æœŸæ”¶ç›Š  
- ä¸ºå¾®æœåŠ¡æ‹†åˆ†å¥ å®šåŸºç¡€
- æé«˜ç³»ç»Ÿå¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§
- æ”¯æŒæ›´çµæ´»çš„éƒ¨ç½²ç­–ç•¥

## ğŸ“ ç›¸å…³æ–‡æ¡£

- [ç³»ç»Ÿæ¶æ„æ–‡æ¡£](../architecture/systemArchitecture.md)
- [é…ç½®ç®¡ç†æŒ‡å—](../../../config/README.md)
- [APIå¼€å‘è§„èŒƒ](../development/api-standards.md)
- [Dockeréƒ¨ç½²æŒ‡å—](../../../deployment/docker/README.md)

---

**æ›´æ–°æ—¶é—´**: 2024-01-15  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**è´Ÿè´£äºº**: RedFireæ¶æ„å›¢é˜Ÿ
