# 配置管理系统使用指南

## 概述

配置管理系统提供了完整的配置加载、验证、管理和热重载功能，支持多种配置文件格式，并内置了强大的验证机制。

## 主要功能

### 1. 配置验证
- 类型验证
- 范围验证
- 长度验证
- 枚举值验证
- 正则表达式验证
- 必需字段验证
- 自定义验证器

### 2. 配置热重载
- 实时监控配置文件变化
- 自动重新加载配置
- 支持回调函数处理配置更新

### 3. 多格式支持
- JSON 格式
- YAML 格式
- 环境变量支持

## 快速开始

### 基本使用

```python
from src.core.config.config_validator import ConfigManager

# 创建配置管理器
config_manager = ConfigManager()

# 加载配置文件
success = config_manager.load_config('config.json')
if success:
    # 获取配置值
    db_host = config_manager.get_config('database.host')
    max_workers = config_manager.get_config('trading_engine.max_workers', default=10)
    
    # 设置配置值
    config_manager.set_config('logging.level', 'INFO')
    
    # 保存配置
    config_manager.save_config('config_updated.json')
```

### 启用热重载

```python
# 启用配置热重载
def on_config_changed(new_config):
    print("配置已更新:", new_config)
    
config_manager.enable_hot_reload('config.json')
# 现在修改配置文件会自动触发回调

# 停止热重载
config_manager.disable_hot_reload()
```

### 自定义验证规则

```python
# 添加自定义验证规则
config_manager.validator.add_validation_rule('api_key', {
    'type': str,
    'required': True,
    'min_length': 32,
    'pattern': r'^[A-Za-z0-9]{32,}$'
})

# 添加自定义验证器
def validate_port_range(port):
    return 1024 <= port <= 65535

config_manager.validator.add_custom_validator('port', validate_port_range)
```

## 配置验证规则

### 类型验证
```python
{
    'type': str,        # 字符串类型
    'type': int,        # 整数类型
    'type': float,      # 浮点数类型
    'type': bool,       # 布尔类型
    'type': list,       # 列表类型
    'type': dict        # 字典类型
}
```

### 范围验证
```python
{
    'min': 0,           # 最小值
    'max': 100          # 最大值
}
```

### 长度验证
```python
{
    'min_length': 1,    # 最小长度
    'max_length': 100   # 最大长度
}
```

### 枚举值验证
```python
{
    'enum': ['DEBUG', 'INFO', 'WARNING', 'ERROR']
}
```

### 正则表达式验证
```python
{
    'pattern': r'^[a-zA-Z0-9_]+$'
}
```

### 必需字段验证
```python
{
    'required': True
}
```

## 配置文件示例

### JSON 格式配置

```json
{
  "database": {
    "host": "localhost",
    "port": 5432,
    "username": "admin",
    "password": "secret123",
    "database": "trading_db"
  },
  "trading_engine": {
    "max_workers": 10,
    "timeout": 30,
    "retry_count": 3
  },
  "logging": {
    "level": "INFO",
    "file": "trading.log",
    "max_size": "100MB",
    "backup_count": 5
  },
  "risk_management": {
    "max_position_size": 1000000,
    "max_daily_loss": 50000,
    "stop_loss_percentage": 0.02
  }
}
```

### YAML 格式配置

```yaml
database:
  host: localhost
  port: 5432
  username: admin
  password: secret123
  database: trading_db

trading_engine:
  max_workers: 10
  timeout: 30
  retry_count: 3

logging:
  level: INFO
  file: trading.log
  max_size: 100MB
  backup_count: 5

risk_management:
  max_position_size: 1000000
  max_daily_loss: 50000
  stop_loss_percentage: 0.02
```

## 高级功能

### 嵌套配置访问

```python
# 支持点号分隔的嵌套键访问
db_host = config_manager.get_config('database.host')
max_workers = config_manager.get_config('trading_engine.max_workers')
log_level = config_manager.get_config('logging.level')
```

### 配置摘要

```python
# 获取配置摘要信息
summary = config_manager.get_config_summary()
print(f"配置键数量: {summary['total_keys']}")
print(f"配置键列表: {summary['config_keys']}")
print(f"验证结果: {summary['validation_result']}")
print(f"热重载状态: {summary['hot_reload_enabled']}")
```

### 配置验证

```python
# 验证当前配置
validation_result = config_manager.validate_current_config()

if validation_result['is_valid']:
    print("配置验证通过")
else:
    print("配置验证失败:")
    for error in validation_result['errors']:
        print(f"  - {error}")
    
if validation_result['warnings']:
    print("配置验证警告:")
    for warning in validation_result['warnings']:
        print(f"  - {warning}")
```

## 最佳实践

### 1. 配置文件组织
- 按功能模块分组配置
- 使用有意义的键名
- 添加配置注释说明

### 2. 验证规则设置
- 为关键配置设置验证规则
- 使用适当的类型和范围限制
- 添加自定义验证器处理复杂逻辑

### 3. 热重载使用
- 仅在开发环境启用热重载
- 实现适当的配置更新处理逻辑
- 注意配置文件变化的频率

### 4. 错误处理
- 检查配置加载结果
- 处理验证错误和警告
- 提供有意义的错误信息

## 常见问题

### Q: 如何添加新的配置验证规则？
A: 使用 `add_validation_rule()` 方法添加验证规则，或使用 `add_custom_validator()` 添加自定义验证器。

### Q: 配置文件变化后如何自动重新加载？
A: 使用 `enable_hot_reload()` 启用热重载功能，并实现配置变化回调函数。

### Q: 如何支持新的配置文件格式？
A: 在 `load_config()` 和 `save_config()` 方法中添加对新格式的支持。

### Q: 如何获取嵌套配置值？
A: 使用点号分隔的键名，如 `config_manager.get_config('database.host')`。

## 依赖要求

```bash
pip install watchdog pyyaml
```

## 注意事项

1. **文件监控**: 热重载功能需要文件系统监控支持，在某些环境下可能需要额外配置
2. **性能影响**: 大量配置验证可能影响性能，建议在生产环境中适当调整
3. **线程安全**: 配置管理器不是线程安全的，在多线程环境中需要适当的同步机制
4. **错误处理**: 配置验证失败时，系统会拒绝加载配置，确保配置文件的正确性

## 更新日志

- **v1.0.0**: 初始版本，支持基本配置管理和验证
- **v1.1.0**: 添加热重载功能和自定义验证器
- **v1.2.0**: 支持嵌套配置访问和多格式配置文件
