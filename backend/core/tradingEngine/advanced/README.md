# é«˜çº§äº¤æ˜“å¼•æ“æ¨¡å—

## ğŸ“‹ æ¦‚è¿°

é«˜çº§äº¤æ˜“å¼•æ“æ¨¡å—æ˜¯åŸºäºvnpy-coreçš„MainEngineå®ç°ï¼Œæä¾›äº†å¢å¼ºçš„äº¤æ˜“å¼•æ“åŠŸèƒ½ï¼ŒåŒ…æ‹¬å¤šè¿æ¥ç®¡ç†ã€è´Ÿè½½å‡è¡¡ã€æ•…éšœè½¬ç§»ã€æ€§èƒ½ç›‘æ§å’Œèµ„æºç®¡ç†ç­‰é«˜çº§ç‰¹æ€§ã€‚

## ğŸš€ ä¸»è¦åŠŸèƒ½

### 1. é«˜çº§ä¸»å¼•æ“ (AdvancedMainEngine)
- **å¤šè¿æ¥ç®¡ç†**: æ”¯æŒå¤šä¸ªç½‘å…³è¿æ¥ï¼Œæ™ºèƒ½ç®¡ç†è¿æ¥çŠ¶æ€
- **è´Ÿè½½å‡è¡¡**: å¤šç§è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œè‡ªåŠ¨ä¼˜åŒ–è´Ÿè½½åˆ†é…
- **æ•…éšœè½¬ç§»**: è‡ªåŠ¨æ•…éšœæ£€æµ‹å’Œæ¢å¤ï¼Œæé«˜ç³»ç»Ÿå¯ç”¨æ€§
- **æ€§èƒ½ç›‘æ§**: å®æ—¶æ€§èƒ½æŒ‡æ ‡ç›‘æ§ï¼Œè‡ªåŠ¨æ€§èƒ½ä¼˜åŒ–
- **èµ„æºç®¡ç†**: æ™ºèƒ½èµ„æºåˆ†é…å’Œå›æ”¶

### 2. å¤šè¿æ¥å¼•æ“ (MultiConnectionEngine)
- **å¤šç½‘å…³è¿æ¥**: åŒæ—¶è¿æ¥å¤šä¸ªäº¤æ˜“ç½‘å…³
- **è¿æ¥æ± ç®¡ç†**: åŠ¨æ€ç®¡ç†è¿æ¥æ•°é‡ï¼Œä¼˜åŒ–èµ„æºä½¿ç”¨
- **æ™ºèƒ½è·¯ç”±**: æ ¹æ®ç­–ç•¥è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ç½‘å…³
- **å¥åº·ç›‘æ§**: å®æ—¶ç›‘æ§ç½‘å…³å¥åº·çŠ¶æ€
- **è‡ªåŠ¨é‡è¿**: æ•…éšœè‡ªåŠ¨æ¢å¤æœºåˆ¶

### 3. è´Ÿè½½å‡è¡¡å¼•æ“ (LoadBalancingEngine)
- **å¤šç§ç®—æ³•**: è½®è¯¢ã€åŠ æƒã€æœ€å°‘è¿æ¥ã€å“åº”æ—¶é—´ç­‰
- **åŠ¨æ€è°ƒæ•´**: æ ¹æ®æ€§èƒ½æŒ‡æ ‡è‡ªåŠ¨è°ƒæ•´è´Ÿè½½åˆ†é…ç­–ç•¥
- **æ€§èƒ½ä¼˜åŒ–**: è‡ªåŠ¨ä¼˜åŒ–è´Ÿè½½åˆ†é…ï¼Œæå‡ç³»ç»Ÿæ€§èƒ½
- **å¥åº·æ£€æŸ¥**: å®æ—¶ç›‘æ§ç½‘å…³å¥åº·çŠ¶æ€
- **ç»Ÿè®¡æŠ¥å‘Š**: è¯¦ç»†çš„è´Ÿè½½å‡è¡¡ç»Ÿè®¡ä¿¡æ¯

### 4. è¿æ¥ç®¡ç†å™¨ (ConnectionManager)
- **è¿æ¥æ± ç®¡ç†**: åˆ›å»ºã€é”€æ¯ã€å¤ç”¨è¿æ¥
- **æ•…éšœè½¬ç§»**: è‡ªåŠ¨æ•…éšœæ£€æµ‹å’Œæ¢å¤
- **å¥åº·ç›‘æ§**: è¿æ¥çŠ¶æ€ç›‘æ§å’Œå‘Šè­¦
- **è´Ÿè½½å‡è¡¡**: æ™ºèƒ½è¿æ¥åˆ†é…

### 5. èµ„æºç®¡ç†å™¨ (ResourceManager)
- **å†…å­˜ç®¡ç†**: å†…å­˜åˆ†é…ã€ç›‘æ§ã€ä¼˜åŒ–
- **CPUç®¡ç†**: CPUä½¿ç”¨ç‡ç›‘æ§ã€è´Ÿè½½å‡è¡¡
- **çº¿ç¨‹ç®¡ç†**: çº¿ç¨‹æ± ç®¡ç†ã€ä»»åŠ¡è°ƒåº¦
- **ç¼“å­˜ç®¡ç†**: ç¼“å­˜ç­–ç•¥ã€å†…å­˜æ¸…ç†
- **æ€§èƒ½ä¼˜åŒ–**: èµ„æºä½¿ç”¨ä¼˜åŒ–å»ºè®®

### 6. å¼•æ“å·¥å…· (EngineUtils)
- **æ€§èƒ½åˆ†æ**: æ€§èƒ½æŒ‡æ ‡è®¡ç®—å’Œåˆ†æ
- **é…ç½®ç®¡ç†**: é…ç½®éªŒè¯å’Œè½¬æ¢
- **æ•°æ®è½¬æ¢**: æ•°æ®æ ¼å¼è½¬æ¢å’ŒéªŒè¯
- **æ—¶é—´å¤„ç†**: æ—¶é—´ç›¸å…³å·¥å…·å‡½æ•°
- **æ—¥å¿—å·¥å…·**: æ—¥å¿—æ ¼å¼åŒ–å’Œåˆ†æ

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
AdvancedMainEngine
â”œâ”€â”€ ConnectionManager (è¿æ¥ç®¡ç†)
â”‚   â”œâ”€â”€ ConnectionPool (è¿æ¥æ± )
â”‚   â”œâ”€â”€ HealthMonitor (å¥åº·ç›‘æ§)
â”‚   â””â”€â”€ FailoverManager (æ•…éšœè½¬ç§»)
â”œâ”€â”€ LoadBalancingEngine (è´Ÿè½½å‡è¡¡)
â”‚   â”œâ”€â”€ AlgorithmSelector (ç®—æ³•é€‰æ‹©å™¨)
â”‚   â”œâ”€â”€ PerformanceAnalyzer (æ€§èƒ½åˆ†æå™¨)
â”‚   â””â”€â”€ AutoAdjuster (è‡ªåŠ¨è°ƒæ•´å™¨)
â”œâ”€â”€ ResourceManager (èµ„æºç®¡ç†)
â”‚   â”œâ”€â”€ MemoryManager (å†…å­˜ç®¡ç†)
â”‚   â”œâ”€â”€ ThreadManager (çº¿ç¨‹ç®¡ç†)
â”‚   â””â”€â”€ PerformanceOptimizer (æ€§èƒ½ä¼˜åŒ–å™¨)
â””â”€â”€ EngineUtils (å·¥å…·ç±»)
    â”œâ”€â”€ PerformanceAnalyzer (æ€§èƒ½åˆ†æ)
    â”œâ”€â”€ ConfigValidator (é…ç½®éªŒè¯)
    â”œâ”€â”€ DataConverter (æ•°æ®è½¬æ¢)
    â”œâ”€â”€ TimeUtils (æ—¶é—´å·¥å…·)
    â””â”€â”€ LogUtils (æ—¥å¿—å·¥å…·)
```

## ğŸ“– ä½¿ç”¨æ–¹æ³•

### 1. åŸºæœ¬ä½¿ç”¨

```python
from backend.core.tradingEngine.advanced import AdvancedMainEngine, ConnectionManager

# åˆ›å»ºé«˜çº§ä¸»å¼•æ“
advanced_engine = AdvancedMainEngine(main_engine, event_engine)

# æ·»åŠ ç½‘å…³
gateway = advanced_engine.add_gateway_with_monitoring(
    gateway_class=MyGateway,
    gateway_name="my_gateway",
    weight=1.0,
    max_connections=10
)

# è·å–æœ€ä¼˜ç½‘å…³
optimal_gateway = advanced_engine.get_optimal_gateway()

# æ›´æ–°è¿æ¥çŠ¶æ€
advanced_engine.update_connection_status(
    gateway_name="my_gateway",
    status=ConnectionStatus.CONNECTED
)
```

### 2. è¿æ¥ç®¡ç†

```python
from backend.core.tradingEngine.advanced.managers import ConnectionManager, ConnectionConfig, ConnectionType

# åˆ›å»ºè¿æ¥ç®¡ç†å™¨
connection_manager = ConnectionManager(main_engine, event_engine)

# åˆ›å»ºè¿æ¥æ± 
config = ConnectionConfig(
    gateway_name="my_gateway",
    connection_type=ConnectionType.TRADING,
    max_connections=10,
    min_connections=2
)

connection_pool = connection_manager.create_connection_pool(config)

# è·å–è¿æ¥
connection = connection_manager.get_optimal_connection(
    gateway_name="my_gateway",
    connection_type=ConnectionType.TRADING,
    strategy="health_based"
)
```

### 3. è´Ÿè½½å‡è¡¡

```python
from backend.core.tradingEngine.advanced.engines import LoadBalancingEngine, LoadBalanceAlgorithm

# åˆ›å»ºè´Ÿè½½å‡è¡¡å¼•æ“
load_balance_engine = LoadBalancingEngine(main_engine, event_engine)

# æ³¨å†Œç½‘å…³
load_balance_engine.register_gateway(
    gateway_name="gateway1",
    max_connections=100,
    weight=2.0,
    priority=1
)

# è·å–æœ€ä¼˜ç½‘å…³
optimal_gateway = load_balance_engine.get_optimal_gateway(
    algorithm=LoadBalanceAlgorithm.WEIGHTED_LEAST_CONNECTIONS
)

# æ›´æ–°ç½‘å…³æŒ‡æ ‡
load_balance_engine.update_gateway_metrics(
    gateway_name="gateway1",
    response_time=150.0,
    success=True,
    connection_count=25
)
```

### 4. èµ„æºç®¡ç†

```python
from backend.core.tradingEngine.advanced.managers import ResourceManager

# åˆ›å»ºèµ„æºç®¡ç†å™¨
resource_manager = ResourceManager(main_engine, event_engine)

# æ³¨å†Œçº¿ç¨‹
import threading
thread = threading.Thread(target=worker_function)
resource_manager.register_thread(thread, pool_name="worker_pool")

# è·å–èµ„æºç»Ÿè®¡
stats = resource_manager.get_resource_stats()
print(f"å†…å­˜ä½¿ç”¨ç‡: {stats['memory']['usage_percent']}%")
print(f"çº¿ç¨‹æ•°é‡: {stats['thread']['active_threads']}")
```

### 5. å·¥å…·å‡½æ•°

```python
from backend.core.tradingEngine.advanced.utils import EngineUtils

# åˆ›å»ºå·¥å…·ç±»å®ä¾‹
utils = EngineUtils()

# æ€§èƒ½æµ‹é‡è£…é¥°å™¨
@utils.measure_performance("database_query")
def query_database():
    # æ•°æ®åº“æŸ¥è¯¢é€»è¾‘
    pass

# é…ç½®éªŒè¯
config = {"host": "localhost", "port": 8080}
is_valid, errors = utils.validate_config(
    config=config,
    required_fields=["host", "port"],
    field_types={"port": int},
    field_ranges={"port": (1, 65535)}
)

if not is_valid:
    print(f"é…ç½®éªŒè¯å¤±è´¥: {errors}")

# è·å–æ€§èƒ½æŠ¥å‘Š
performance_report = utils.get_performance_report()
print(f"æ€»æ“ä½œæ•°: {performance_report['total_operations']}")
```

## âš™ï¸ é…ç½®é€‰é¡¹

### é«˜çº§ä¸»å¼•æ“é…ç½®

```python
# è¿æ¥ç®¡ç†é…ç½®
connection_config = {
    "max_connections": 100,
    "min_connections": 10,
    "connection_timeout": 30.0,
    "heartbeat_interval": 10.0,
    "retry_interval": 5.0,
    "max_retries": 3
}

# è´Ÿè½½å‡è¡¡é…ç½®
load_balance_config = {
    "algorithm": "weighted_least_connections",
    "auto_adjust_enabled": True,
    "adjustment_interval": 30.0
}

# æ•…éšœè½¬ç§»é…ç½®
failover_config = {
    "enabled": True,
    "auto_reconnect": True,
    "failover_threshold": 3
}
```

### æ€§èƒ½é˜ˆå€¼é…ç½®

```python
# æ€§èƒ½ç›‘æ§é˜ˆå€¼
performance_thresholds = {
    "max_response_time": 1000.0,    # æœ€å¤§å“åº”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    "max_error_rate": 0.1,          # æœ€å¤§é”™è¯¯ç‡
    "max_connection_usage": 0.8,    # æœ€å¤§è¿æ¥ä½¿ç”¨ç‡
    "memory_warning_threshold": 75.0,  # å†…å­˜è­¦å‘Šé˜ˆå€¼
    "memory_critical_threshold": 90.0  # å†…å­˜ä¸¥é‡é˜ˆå€¼
}
```

## ğŸ“Š ç›‘æ§å’Œç»Ÿè®¡

### 1. è¿æ¥çŠ¶æ€ç›‘æ§

```python
# è·å–è¿æ¥ç»Ÿè®¡
connection_stats = advanced_engine.get_connection_stats()

for gateway_name, stats in connection_stats.items():
    print(f"ç½‘å…³ {gateway_name}:")
    print(f"  çŠ¶æ€: {stats['status']}")
    print(f"  è¿æ¥æ—¶é—´: {stats['connect_time']}")
    print(f"  å“åº”æ—¶é—´: {stats['response_time']}")
    print(f"  é”™è¯¯æ¬¡æ•°: {stats['error_count']}")
```

### 2. è´Ÿè½½å‡è¡¡ç»Ÿè®¡

```python
# è·å–è´Ÿè½½å‡è¡¡ç»Ÿè®¡
load_balance_stats = load_balance_engine.get_load_balance_stats()

print(f"å½“å‰ç®—æ³•: {load_balance_stats['algorithm']}")
print(f"è‡ªåŠ¨è°ƒæ•´: {load_balance_stats['auto_adjust_enabled']}")

for gateway_name, gateway_stats in load_balance_stats['gateway_loads'].items():
    print(f"ç½‘å…³ {gateway_name}:")
    print(f"  è¿æ¥ä½¿ç”¨ç‡: {gateway_stats['connection_usage']:.2%}")
    print(f"  å¹³å‡å“åº”æ—¶é—´: {gateway_stats['avg_response_time']:.2f}ms")
    print(f"  é”™è¯¯ç‡: {gateway_stats['error_rate']:.2%}")
    print(f"  è´Ÿè½½è¯„åˆ†: {gateway_stats['load_score']:.4f}")
```

### 3. èµ„æºä½¿ç”¨ç»Ÿè®¡

```python
# è·å–èµ„æºç»Ÿè®¡
resource_stats = resource_manager.get_resource_stats()

print(f"å†…å­˜ä½¿ç”¨ç‡: {resource_stats['memory']['usage_percent']:.1f}%")
print(f"CPUä½¿ç”¨ç‡: {resource_stats['cpu']['usage_percent']:.1f}%")
print(f"æ´»è·ƒçº¿ç¨‹æ•°: {resource_stats['thread']['active_threads']}")
```

## ğŸ§ª æµ‹è¯•

è¿è¡Œæµ‹è¯•æ–‡ä»¶éªŒè¯æ¨¡å—åŠŸèƒ½ï¼š

```bash
cd backend/core/tradingEngine/advanced
python test_advanced_engines.py
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ä¾èµ–ç®¡ç†**: ç¡®ä¿å®‰è£…äº†æ‰€éœ€çš„ä¾èµ–åŒ…ï¼ˆå¦‚psutilï¼‰
2. **çº¿ç¨‹å®‰å…¨**: æ‰€æœ‰æ“ä½œéƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„
3. **èµ„æºæ¸…ç†**: ä½¿ç”¨å®Œæ¯•åè®°å¾—è°ƒç”¨close()æ–¹æ³•æ¸…ç†èµ„æº
4. **æ€§èƒ½ç›‘æ§**: å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯ç”¨æ€§èƒ½ç›‘æ§
5. **é…ç½®éªŒè¯**: ä½¿ç”¨é…ç½®éªŒè¯åŠŸèƒ½ç¡®ä¿é…ç½®æ­£ç¡®æ€§

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **å¯¼å…¥é”™è¯¯**: æ£€æŸ¥æ¨¡å—è·¯å¾„å’Œä¾èµ–å…³ç³»
2. **è¿æ¥å¤±è´¥**: æ£€æŸ¥ç½‘å…³é…ç½®å’Œç½‘ç»œè¿æ¥
3. **æ€§èƒ½ä¸‹é™**: æ£€æŸ¥èµ„æºä½¿ç”¨æƒ…å†µå’Œè´Ÿè½½å‡è¡¡é…ç½®
4. **å†…å­˜æ³„æ¼**: æ£€æŸ¥æ˜¯å¦æ­£ç¡®è°ƒç”¨äº†close()æ–¹æ³•

### è°ƒè¯•æŠ€å·§

1. å¯ç”¨è¯¦ç»†æ—¥å¿—è®°å½•
2. ä½¿ç”¨æ€§èƒ½ç›‘æ§å·¥å…·
3. æ£€æŸ¥ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
4. éªŒè¯é…ç½®å‚æ•°æ­£ç¡®æ€§

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [vnpy-coreæ–‡æ¡£](https://www.vnpy.com/docs/)
- [äº¤æ˜“å¼•æ“æ¶æ„è®¾è®¡](./ARCHITECTURE.md)
- [APIå‚è€ƒæ–‡æ¡£](./API_REFERENCE.md)
- [æ€§èƒ½è°ƒä¼˜æŒ‡å—](./PERFORMANCE_TUNING.md)

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestæ¥æ”¹è¿›è¿™ä¸ªæ¨¡å—ã€‚

## ï¿½ï¿½ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ã€‚
