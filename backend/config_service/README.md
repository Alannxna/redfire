# ğŸ”§ RedFireå¤–éƒ¨é…ç½®ç®¡ç†æœåŠ¡

## ğŸ“‹ æ¦‚è¿°

RedFireé…ç½®ç®¡ç†æœåŠ¡æ˜¯ä¸€ä¸ªåŸºäºå¤–éƒ¨å¾®æœåŠ¡æ¶æ„çš„é…ç½®ç®¡ç†ç³»ç»Ÿï¼Œå®Œå…¨èˆå¼ƒäº†å¤æ‚çš„DDDæ¶æ„ï¼Œé‡‡ç”¨ç®€å•ç›´æ¥çš„ä¸‰å±‚æ¶æ„è®¾è®¡ã€‚

### âœ¨ æ ¸å¿ƒç‰¹æ€§

- **ğŸ¯ ç®€å•æ¶æ„**: èˆå¼ƒDDDå¤æ‚æ€§ï¼Œé‡‡ç”¨ API â†’ Service â†’ Repository ä¸‰å±‚æ¶æ„
- **ğŸ“„ å¤šæºé…ç½®**: æ”¯æŒæ–‡ä»¶ã€ç¯å¢ƒå˜é‡ã€å­—å…¸ç­‰å¤šç§é…ç½®æº
- **ğŸ”„ çƒ­é‡è½½**: å®æ—¶ç›‘å¬é…ç½®æ–‡ä»¶å˜æ›´ï¼Œè‡ªåŠ¨é‡æ–°åŠ è½½
- **ğŸ›¡ï¸ ç±»å‹å®‰å…¨**: åŸºäºPydanticçš„ç±»å‹å®‰å…¨é…ç½®æ¨¡å‹
- **âš¡ é«˜æ€§èƒ½**: FastAPI + å¼‚æ­¥I/Oï¼Œæ”¯æŒé«˜å¹¶å‘
- **ğŸ” é…ç½®éªŒè¯**: è‡ªåŠ¨é…ç½®éªŒè¯å’Œé”™è¯¯æç¤º
- **ğŸ’¾ æ™ºèƒ½ç¼“å­˜**: å¤šçº§ç¼“å­˜æå‡é…ç½®è®¿é—®æ€§èƒ½
- **ğŸ“Š REST API**: å®Œæ•´çš„RESTful APIæ”¯æŒCRUDæ“ä½œ
- **ğŸ”” äº‹ä»¶é€šçŸ¥**: é…ç½®å˜æ›´å®æ—¶é€šçŸ¥æœºåˆ¶

### ğŸ—ï¸ æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            å¤–éƒ¨å¾®æœåŠ¡æ¶æ„                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸŒ REST API å±‚                        â”‚
â”‚  â”œâ”€â”€ é…ç½®CRUDæ¥å£                       â”‚
â”‚  â”œâ”€â”€ å¥åº·æ£€æŸ¥æ¥å£                       â”‚
â”‚  â””â”€â”€ é…ç½®éªŒè¯æ¥å£                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ”§ æœåŠ¡å±‚ (Core)                      â”‚
â”‚  â”œâ”€â”€ é…ç½®ç®¡ç†å™¨                         â”‚
â”‚  â”œâ”€â”€ æ–‡ä»¶ç›‘å¬å™¨                         â”‚
â”‚  â”œâ”€â”€ ç¼“å­˜ç®¡ç†å™¨                         â”‚
â”‚  â””â”€â”€ äº‹ä»¶é€šçŸ¥å™¨                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“¦ æ¨¡å‹å±‚ (Models)                     â”‚
â”‚  â”œâ”€â”€ Pydanticé…ç½®æ¨¡å‹                   â”‚
â”‚  â”œâ”€â”€ é…ç½®éªŒè¯å™¨                         â”‚
â”‚  â””â”€â”€ ç±»å‹å®šä¹‰                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
cd backend/config_service
pip install -r requirements.txt
```

### 2. é…ç½®ç¯å¢ƒ

å¤åˆ¶å¹¶ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼š

```bash
cp config/development.yaml config/production.yaml
# ç¼–è¾‘ config/production.yaml è®¾ç½®ç”Ÿäº§ç¯å¢ƒé…ç½®
```

### 3. å¯åŠ¨æœåŠ¡

#### æ–¹å¼ä¸€ï¼šä½¿ç”¨å¯åŠ¨è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# ä½¿ç”¨é»˜è®¤é…ç½®å¯åŠ¨
python start_service.py

# ä½¿ç”¨æŒ‡å®šé…ç½®æ–‡ä»¶å¯åŠ¨
python start_service.py --config config/production.yaml

# å¯ç”¨çƒ­é‡è½½ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
python start_service.py --reload

# è‡ªå®šä¹‰ä¸»æœºå’Œç«¯å£
python start_service.py --host 127.0.0.1 --port 8080
```

#### æ–¹å¼äºŒï¼šä½¿ç”¨CLIå‘½ä»¤

```bash
# è¿è¡ŒæœåŠ¡
python -m backend.config_service.main run

# ä½¿ç”¨æŒ‡å®šé…ç½®
python -m backend.config_service.main run --config-file config/production.yaml

# éªŒè¯é…ç½®æ–‡ä»¶
python -m backend.config_service.main validate --config-file config/development.yaml

# ç”Ÿæˆé…ç½®æ¨¡æ¿
python -m backend.config_service.main template --output my_config.yaml

# æŸ¥çœ‹é…ç½®ä¿¡æ¯
python -m backend.config_service.main info

# å¥åº·æ£€æŸ¥
python -m backend.config_service.main health
```

#### æ–¹å¼ä¸‰ï¼šç¨‹åºè°ƒç”¨

```python
import asyncio
from backend.config_service import quick_start

# å¿«é€Ÿå¯åŠ¨
asyncio.run(quick_start("config/development.yaml"))
```

### 4. è®¿é—®æœåŠ¡

- **æœåŠ¡åœ°å€**: http://localhost:8001
- **APIæ–‡æ¡£**: http://localhost:8001/docs
- **ReDocæ–‡æ¡£**: http://localhost:8001/redoc
- **å¥åº·æ£€æŸ¥**: http://localhost:8001/health

## ğŸ“– ä½¿ç”¨æŒ‡å—

### é…ç½®æ¨¡å‹

é…ç½®æœåŠ¡æ”¯æŒå¤šç§é…ç½®ç±»å‹ï¼š

```python
from backend.config_service import (
    AppConfig, DatabaseConfig, RedisConfig, 
    VnPyConfig, SecurityConfig, MonitoringConfig
)

# ä¸»é…ç½®
config = AppConfig(
    app_name="My App",
    environment="production",
    database=DatabaseConfig(
        engine="postgresql",
        host="localhost",
        port=5432,
        database="mydb"
    ),
    redis=RedisConfig(
        host="localhost",
        port=6379
    )
)
```

### é…ç½®æ–‡ä»¶æ ¼å¼

æ”¯æŒYAMLå’ŒJSONæ ¼å¼ï¼š

```yaml
# config.yaml
app_name: "RedFire Config Service"
environment: "development"
debug: true

database:
  engine: "postgresql"
  host: "localhost"
  port: 5432
  database: "redfire"
  username: "user"
  password: "pass"

redis:
  host: "localhost"
  port: 6379
  db: 0

security:
  secret_key: "your-secret-key"
  algorithm: "HS256"
```

### ç¯å¢ƒå˜é‡

æ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡é…ç½®ï¼š

```bash
# åº”ç”¨é…ç½®
export APP_NAME="My Service"
export APP_ENVIRONMENT="production"
export APP_DEBUG=false

# æ•°æ®åº“é…ç½®ï¼ˆä½¿ç”¨åŒä¸‹åˆ’çº¿è¡¨ç¤ºåµŒå¥—ï¼‰
export DB__HOST="prod-db.example.com"
export DB__PORT=5432
export DB__DATABASE="myapp"
export DB__USERNAME="dbuser"
export DB__PASSWORD="dbpass"

# Redisé…ç½®
export REDIS__HOST="redis.example.com"
export REDIS__PORT=6379
```

### ç¼–ç¨‹æ–¹å¼ä½¿ç”¨

#### åˆå§‹åŒ–é…ç½®

```python
from backend.config_service import initialize_config, get_config

# ä»æ–‡ä»¶åˆå§‹åŒ–
config = await initialize_config("config.yaml")

# ä»ç¯å¢ƒå˜é‡åˆå§‹åŒ–
config = await initialize_config()

# ä»å­—å…¸åˆå§‹åŒ–
config_dict = {"app_name": "Test", "debug": True}
config = await initialize_config(config_dict=config_dict)
```

#### è·å–é…ç½®

```python
from backend.config_service import (
    get_config, get_database_config, get_redis_config
)

# è·å–å®Œæ•´é…ç½®
config = get_config()
print(f"App: {config.app_name} v{config.app_version}")

# è·å–ç‰¹å®šé…ç½®
db_config = get_database_config()
redis_config = get_redis_config()

# è·å–åµŒå¥—é…ç½®
from backend.config_service.core.config_manager import config_manager
db_host = config_manager.get_nested_config("database.host")
```

#### é…ç½®çƒ­é‡è½½

```python
from backend.config_service import reload_config

# æ‰‹åŠ¨é‡æ–°åŠ è½½é…ç½®
success = await reload_config()

# æ³¨å†Œé…ç½®å˜æ›´å›è°ƒ
def on_config_change(new_config):
    print(f"é…ç½®å·²æ›´æ–°: {new_config.app_name}")

config_manager.add_change_callback(on_config_change)
```

## ğŸ”Œ APIæ¥å£

### è®¤è¯

æ‰€æœ‰APIæ¥å£éœ€è¦Bearer Tokenè®¤è¯ï¼š

```bash
curl -H "Authorization: Bearer your-token" http://localhost:8001/config
```

### ä¸»è¦æ¥å£

#### è·å–é…ç½®

```bash
# è·å–å®Œæ•´é…ç½®
GET /config

# è·å–ç‰¹å®šè·¯å¾„é…ç½®
GET /config?key_path=database.host

# åŒ…å«æ•æ„Ÿä¿¡æ¯
GET /config?include_sensitive=true
```

#### æ›´æ–°é…ç½®

```bash
# æ›´æ–°é…ç½®
PUT /config
{
    "updates": {
        "debug": true,
        "database": {
            "pool_size": 50
        }
    }
}

# è¯•è¿è¡Œæ¨¡å¼
PUT /config
{
    "updates": {...},
    "dry_run": true
}
```

#### é‡æ–°åŠ è½½é…ç½®

```bash
POST /config/reload
```

#### è·å–ç‰¹å®šé…ç½®

```bash
GET /config/database    # æ•°æ®åº“é…ç½®
GET /config/redis       # Redisé…ç½®
GET /config/vnpy        # VnPyé…ç½®
GET /config/security    # å®‰å…¨é…ç½®
```

#### å¥åº·æ£€æŸ¥

```bash
GET /health
```

#### é…ç½®ä¿¡æ¯

```bash
GET /config/info
```

### å“åº”æ ¼å¼

```json
{
    "success": true,
    "message": "é…ç½®è·å–æˆåŠŸ",
    "data": {
        "app_name": "RedFire Config Service",
        "environment": "development"
    },
    "timestamp": "2024-01-01T00:00:00"
}
```

## ğŸ› ï¸ å¼€å‘æŒ‡å—

### é¡¹ç›®ç»“æ„

```
backend/config_service/
â”œâ”€â”€ __init__.py              # åŒ…åˆå§‹åŒ–
â”œâ”€â”€ main.py                  # æœåŠ¡å¯åŠ¨å…¥å£
â”œâ”€â”€ start_service.py         # å¿«é€Ÿå¯åŠ¨è„šæœ¬
â”œâ”€â”€ requirements.txt         # ä¾èµ–åˆ—è¡¨
â”œâ”€â”€ README.md               # æ–‡æ¡£
â”œâ”€â”€ models/                 # é…ç½®æ¨¡å‹
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ config_models.py    # Pydanticæ¨¡å‹
â”œâ”€â”€ core/                   # æ ¸å¿ƒæœåŠ¡
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ config_manager.py   # é…ç½®ç®¡ç†å™¨
â”œâ”€â”€ api/                    # APIæ¥å£
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ config_api.py       # REST API
â””â”€â”€ config/                 # é…ç½®æ–‡ä»¶
    â””â”€â”€ development.yaml    # å¼€å‘ç¯å¢ƒé…ç½®
```

### æ·»åŠ æ–°é…ç½®ç±»å‹

1. åœ¨ `config_models.py` ä¸­å®šä¹‰æ–°çš„é…ç½®æ¨¡å‹ï¼š

```python
class MyServiceConfig(BaseSettings):
    """æˆ‘çš„æœåŠ¡é…ç½®"""
    host: str = Field("localhost", description="æœåŠ¡ä¸»æœº")
    port: int = Field(8080, description="æœåŠ¡ç«¯å£")
    
    class Config:
        env_prefix = "MY_SERVICE_"
```

2. åœ¨ä¸»é…ç½®ä¸­æ·»åŠ æ–°é…ç½®ï¼š

```python
class AppConfig(BaseSettings):
    # ... å…¶ä»–é…ç½®
    my_service: MyServiceConfig = Field(default_factory=MyServiceConfig)
```

3. åœ¨é…ç½®ç®¡ç†å™¨ä¸­æ·»åŠ ä¾¿æ·æ–¹æ³•ï¼š

```python
def get_my_service_config():
    """è·å–æˆ‘çš„æœåŠ¡é…ç½®"""
    return config_manager.get_config().my_service
```

### è‡ªå®šä¹‰éªŒè¯å™¨

```python
from pydantic import validator

class MyConfig(BaseSettings):
    port: int
    
    @validator('port')
    def validate_port(cls, v):
        if not 1 <= v <= 65535:
            raise ValueError('ç«¯å£å¿…é¡»åœ¨1-65535ä¹‹é—´')
        return v
```

### é…ç½®å˜æ›´ç›‘å¬

```python
def on_config_change(new_config: AppConfig):
    # å¤„ç†é…ç½®å˜æ›´
    print(f"é…ç½®å·²æ›´æ–°: {new_config.app_name}")
    
    # é‡æ–°åˆå§‹åŒ–æœåŠ¡ç»„ä»¶
    reinitialize_services(new_config)

config_manager.add_change_callback(on_config_change)
```

## ğŸ§ª æµ‹è¯•

### è¿è¡Œæµ‹è¯•

```bash
# å®‰è£…æµ‹è¯•ä¾èµ–
pip install pytest pytest-asyncio pytest-cov

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest

# è¿è¡Œè¦†ç›–ç‡æµ‹è¯•
pytest --cov=backend.config_service

# è¿è¡Œç‰¹å®šæµ‹è¯•
pytest tests/test_config_models.py
```

### æµ‹è¯•ç¤ºä¾‹

```python
import pytest
from backend.config_service import initialize_config, get_config

@pytest.mark.asyncio
async def test_config_loading():
    """æµ‹è¯•é…ç½®åŠ è½½"""
    config = await initialize_config("tests/fixtures/test_config.yaml")
    assert config.app_name == "Test App"
    assert config.environment == "testing"

@pytest.mark.asyncio
async def test_config_validation():
    """æµ‹è¯•é…ç½®éªŒè¯"""
    invalid_config = {"database": {"port": 70000}}  # æ— æ•ˆç«¯å£
    
    with pytest.raises(ValueError):
        await initialize_config(config_dict=invalid_config)
```

## ğŸ”§ éƒ¨ç½²

### Dockeréƒ¨ç½²

```dockerfile
FROM python:3.11-slim

WORKDIR /app
COPY backend/config_service/ ./
RUN pip install -r requirements.txt

EXPOSE 8001
CMD ["python", "main.py", "run"]
```

### ç¯å¢ƒå˜é‡é…ç½®

```bash
# .env
APP_NAME=RedFire Config Service
APP_ENVIRONMENT=production
APP_DEBUG=false
APP_HOST=0.0.0.0
APP_PORT=8001

DB__ENGINE=postgresql
DB__HOST=postgres.example.com
DB__PORT=5432
DB__DATABASE=redfire
DB__USERNAME=dbuser
DB__PASSWORD=dbpass

SECURITY__SECRET_KEY=your-production-secret-key
```

### å¥åº·æ£€æŸ¥

```bash
# Dockerå¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8001/health || exit 1
```

## ğŸ“Š ç›‘æ§

### PrometheusæŒ‡æ ‡

é…ç½®æœåŠ¡è‡ªåŠ¨æš´éœ²PrometheusæŒ‡æ ‡ï¼š

- `config_requests_total`: é…ç½®è¯·æ±‚æ€»æ•°
- `config_reload_total`: é…ç½®é‡è½½æ¬¡æ•°
- `config_validation_errors_total`: é…ç½®éªŒè¯é”™è¯¯æ•°
- `config_cache_hits_total`: é…ç½®ç¼“å­˜å‘½ä¸­æ•°

### æ—¥å¿—è®°å½•

```python
import logging

# é…ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)

# æŸ¥çœ‹é…ç½®æœåŠ¡æ—¥å¿—
logger = logging.getLogger('backend.config_service')
```

## â“ å¸¸è§é—®é¢˜

### Q: å¦‚ä½•å¤„ç†æ•æ„Ÿé…ç½®ä¿¡æ¯ï¼Ÿ

A: ä½¿ç”¨ `SecretStr` ç±»å‹å’Œç¯å¢ƒå˜é‡ï¼š

```python
from pydantic import SecretStr

class SecurityConfig(BaseSettings):
    secret_key: SecretStr = Field(..., env="SECRET_KEY")
    
    def get_secret_value(self):
        return self.secret_key.get_secret_value()
```

### Q: é…ç½®çƒ­é‡è½½ä¸å·¥ä½œï¼Ÿ

A: æ£€æŸ¥ä»¥ä¸‹é¡¹ç›®ï¼š
1. æ–‡ä»¶ç›‘å¬æ˜¯å¦å¯ç”¨ï¼š`enable_file_watching=True`
2. é…ç½®æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
3. æ–‡ä»¶æƒé™æ˜¯å¦æ­£ç¡®
4. æ˜¯å¦æœ‰æ–‡ä»¶é”å®š

### Q: å¦‚ä½•è‡ªå®šä¹‰é…ç½®éªŒè¯ï¼Ÿ

A: ä½¿ç”¨PydanticéªŒè¯å™¨ï¼š

```python
@validator('database_url')
def validate_database_url(cls, v):
    if not v.startswith(('postgresql://', 'mysql://')):
        raise ValueError('ä¸æ”¯æŒçš„æ•°æ®åº“URLæ ¼å¼')
    return v
```

### Q: å¦‚ä½•å¤„ç†é…ç½®å‡çº§ï¼Ÿ

A: å®ç°é…ç½®è¿ç§»å‡½æ•°ï¼š

```python
def migrate_config_v1_to_v2(old_config: dict) -> dict:
    """é…ç½®ç‰ˆæœ¬å‡çº§"""
    new_config = old_config.copy()
    # æ‰§è¡Œå‡çº§é€»è¾‘
    return new_config
```

## ğŸ“š æ›´å¤šèµ„æº

- [Pydanticæ–‡æ¡£](https://docs.pydantic.dev/)
- [FastAPIæ–‡æ¡£](https://fastapi.tiangolo.com/)
- [é…ç½®æœ€ä½³å®è·µ](https://12factor.net/config)

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestï¼

## ğŸ“„ è®¸å¯è¯

MIT License
